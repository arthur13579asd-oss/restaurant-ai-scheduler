<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å»³ AI æ’ç­ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* é ‚éƒ¨å°èˆª */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .navbar h1 {
            font-size: 22px;
        }

        .navbar .store-name {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        /* Tab å°èˆª */
        .tabs {
            background: white;
            display: flex;
            border-bottom: 2px solid #e8ebf2;
            padding: 0 20px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* ä¸»å…§å®¹å€ */
        .main-content {
            padding: 25px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .card h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 .badge {
            background: #667eea;
            color: white;
            font-size: 12px;
            padding: 3px 10px;
            border-radius: 10px;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 13px;
            font-weight: 500;
            color: #555;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select {
            padding: 10px 12px;
            border: 2px solid #e8ebf2;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* å“¡å·¥åˆ—è¡¨ */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .employee-card {
            background: #f8f9fc;
            border: 2px solid #e8ebf2;
            border-radius: 12px;
            padding: 15px;
            position: relative;
        }

        .employee-card.fulltime {
            border-left: 4px solid #28a745;
        }

        .employee-card.parttime {
            border-left: 4px solid #ffc107;
        }

        .employee-card .header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .employee-card .name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .employee-card .type-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .employee-card .type-badge.fulltime {
            background: #d4edda;
            color: #155724;
        }

        .employee-card .type-badge.parttime {
            background: #fff3cd;
            color: #856404;
        }

        .employee-card .info {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .employee-card .availability {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .employee-card .day-chip {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            background: #e8f5e9;
            color: #2e7d32;
        }

        .employee-card .day-chip.unavailable {
            background: #ffebee;
            color: #c62828;
            text-decoration: line-through;
        }

        .employee-card .actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .employee-card .actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.5;
        }

        .employee-card .actions button:hover {
            opacity: 1;
        }

        /* ç­æ¬¡è¨­å®š */
        .shift-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .shift-item {
            display: grid;
            grid-template-columns: 30px 2fr 1.5fr 1.5fr 1fr 1fr 80px;
            gap: 10px;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            background: white;
            transition: background 0.2s;
        }
        .shift-item.dragging {
            opacity: 0.5;
            background: #f0f2f5;
        }
        .drag-handle {
            cursor: grab;
            color: #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .drag-handle:active {
            cursor: grabbing;
        }

        .shift-item input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .shift-item .delete-btn {
            background: #ffebee;
            color: #c62828;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* æ—¥æ›†è¦–åœ– */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .calendar-nav button {
            background: #f0f2f5;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .calendar-nav button:hover {
            background: #e0e3e8;
        }

        .calendar-nav .month-label {
            font-size: 18px;
            font-weight: 600;
            min-width: 150px;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            background: #e8ebf2;
            border-radius: 12px;
            overflow: hidden;
        }

        .calendar-grid .day-header {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
        }

        .calendar-grid .day-cell {
            background: white;
            min-height: 120px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-grid .day-cell:hover {
            background: #f8f9fc;
        }

        .calendar-grid .day-cell.other-month {
            background: #f5f5f5;
            color: #aaa;
        }

        .calendar-grid .day-cell.today {
            background: #e3f2fd;
        }

        .calendar-grid .day-cell.peak {
            background: #fff3e0;
        }

        .calendar-grid .day-cell.holiday {
            background: #fce4ec;
        }

        .calendar-grid .day-cell .date {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .calendar-grid .day-cell .date .holiday-name {
            font-size: 10px;
            color: #e91e63;
            font-weight: normal;
        }

        .calendar-grid .day-cell .peak-badge {
            display: inline-block;
            font-size: 10px;
            background: #ff9800;
            color: white;
            padding: 1px 6px;
            border-radius: 3px;
            margin-left: 5px;
        }

        .calendar-grid .day-cell .shift-preview {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .calendar-grid .day-cell .staff-count {
            font-size: 10px;
            color: #888;
        }

        /* å¤©æ°£æ¨£å¼ */
        .weather-info {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #555;
            margin-top: 4px;
            background: rgba(255,255,255,0.8);
            padding: 2px 4px;
            border-radius: 4px;
        }
        .weather-icon {
            width: 16px;
            height: 16px;
        }
        .weather-temp {
            font-weight: 600;
        }
        .weather-pop {
            color: #1565c0;
            font-size: 10px;
        }
        .schedule-weather {
            font-size: 11px;
            margin: 5px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            background: rgba(255, 255, 255, 0.5);
            padding: 4px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .weather-main {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }
        .weather-detail {
            display: flex;
            gap: 6px;
            font-size: 10px;
            color: #666;
        }
        .high-pop {
            color: #d32f2f !important;
            font-weight: bold;
        }

        /* AI æ’ç­æŒ‰éˆ• */
        .ai-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 25px;
            color: white;
            margin-bottom: 20px;
        }

        .ai-section h2 {
            color: white;
            margin-bottom: 15px;
        }

        .ai-section p {
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .ai-section .btn-ai {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .ai-section .btn-ai:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        /* æ’ç­è¡¨æ ¼ */
        .schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 13px;
        }

        .schedule-table th {
            background: #f8f9fc;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e8ebf2;
            position: sticky;
            top: 0;
        }

        .schedule-table th.peak {
            background: #fff3e0;
        }

        .schedule-table th.holiday {
            background: #fce4ec;
        }

        .schedule-table th .date-info {
            font-size: 11px;
            color: #888;
            font-weight: normal;
        }

        .schedule-table td {
            border: 1px solid #e8ebf2;
            padding: 8px;
            vertical-align: top;
            min-width: 120px;
        }

        .schedule-table td.shift-label {
            background: #f8f9fc;
            font-weight: 600;
            text-align: center;
            min-width: 100px;
        }

        .schedule-table .staff-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .schedule-table .staff-tag {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            background: #e3f2fd;
            color: #1565c0;
            cursor: pointer;
        }

        .schedule-table .staff-tag.fulltime {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .schedule-table .staff-tag.parttime {
            background: #fff8e1;
            color: #f57f17;
        }

        .schedule-table .need-more {
            font-size: 10px;
            color: #f44336;
            margin-top: 4px;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* å¿«é€Ÿæ–°å¢å“¡å·¥é¸å–® */
        .quick-add-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #f1f5f9;
            color: #64748b;
            border: 1px dashed #cbd5e0;
            cursor: pointer;
            font-size: 14px;
            margin-top: 4px;
            transition: all 0.2s;
        }
        .quick-add-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: scale(1.1);
        }
        .quick-add-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 6px;
            z-index: 2000;
            display: none;
            min-width: 140px;
            border: 1px solid #e2e8f0;
        }
        .quick-add-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            font-size: 13px;
            color: #1e293b;
        }
        .quick-add-item:hover {
            background: #f1f5f9;
            color: #667eea;
        }
        .quick-add-item .type-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .quick-add-item.fulltime .type-dot { background: #28a745; }
        .quick-add-item.parttime .type-dot { background: #ff9800; }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* åœ–ä¾‹ */
        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        /* å½ˆçª— */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            flex: 1;
        }

        /* é€±é¸æ“‡å™¨ */
        .week-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
        }

        .week-day-btn {
            padding: 8px 16px;
            border: 2px solid #e8ebf2;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .week-day-btn.selected {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .week-day-btn:hover:not(.selected) {
            border-color: #667eea;
        }

        /* çµ±è¨ˆå€ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: #f8f9fc;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card .name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-card .hours {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .stat-card .hours small {
            font-size: 14px;
            color: #888;
        }

        .stat-card .days {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 768px) {
            .shift-item {
                grid-template-columns: 1fr 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="navbar">
        <h1>AI æ’ç­ç³»çµ±</h1>
        <span class="store-name">å®œè˜­ç¾…æ±åº—</span>
    </nav>

    <!-- Tab å°èˆª -->
    <div class="tabs">
        <div class="tab active" data-tab="schedule">æ’ç­è¡¨</div>
        <div class="tab" data-tab="employees">å“¡å·¥ç®¡ç†</div>
        <div class="tab" data-tab="shifts">ç­æ¬¡è¨­å®š</div>
        <div class="tab" data-tab="calendar">å‡æ—¥æ—¥æ›†</div>
        <div class="tab" data-tab="settings">æ—ºæ—¥è¨­å®š</div>
    </div>

    <!-- ä¸»å…§å®¹å€ -->
    <div class="main-content">

        <!-- ===== æ’ç­è¡¨ Tab ===== -->
        <div class="tab-content active" id="tab-schedule">
            <!-- AI æ’ç­å€ -->
            <div class="ai-section">
                <h2>AI æ™ºèƒ½æ’ç­</h2>
                <p>æ ¹æ“šå“¡å·¥å¯ç”¨æ™‚æ®µã€æ—ºæ—¥/å¹³æ—¥éœ€æ±‚ã€ä»¥åŠå°ç£åœ‹å®šå‡æ—¥è‡ªå‹•ç”Ÿæˆæœ€ä½³æ’ç­</p>
                <button class="btn-ai" onclick="generateAISchedule()">é–‹å§‹ AI æ’ç­</button>
            </div>

            <!-- é€±é¸æ“‡ -->
            <div class="card">
                <div class="calendar-header">
                    <h2>æœ¬é€±æ’ç­è¡¨</h2>
                    <div class="calendar-nav">
                        <button onclick="prevWeek()">&lt; ä¸Šé€±</button>
                        <span class="month-label" id="weekLabel">2025/01/20 - 01/26</span>
                        <button onclick="nextWeek()">ä¸‹é€± &gt;</button>
                    </div>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background:#e8f5e9"></div>
                        <span>æ­£è·</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background:#fff8e1"></div>
                        <span>å…¼è·</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background:#fce4ec"></div>
                        <span>åœ‹å®šå‡æ—¥</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background:#fff3e0"></div>
                        <span>æ—ºæ—¥</span>
                    </div>
                </div>

                <div style="overflow-x: auto;">
                    <table class="schedule-table" id="scheduleTable">
                        <!-- å‹•æ…‹ç”Ÿæˆ -->
                    </table>
                </div>

                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="saveSchedule()">å„²å­˜æ’ç­</button>
                    <button class="btn btn-secondary" onclick="exportCSV()">åŒ¯å‡º CSV</button>
                    <button class="btn btn-danger" onclick="clearWeekSchedule()">æ¸…ç©ºæœ¬é€±</button>
                </div>
            </div>

            <!-- å·¥æ™‚çµ±è¨ˆ -->
            <div class="card">
                <h2>æ¯æ—¥ç¸½å·¥æ™‚çµ±è¨ˆ</h2>
                <div class="stats-grid" id="statsGrid">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- ===== å“¡å·¥ç®¡ç† Tab ===== -->
        <div class="tab-content" id="tab-employees">
            <div class="card">
                <h2>
                    å“¡å·¥åˆ—è¡¨
                    <span class="badge" id="employeeCount">0 äºº</span>
                </h2>
                <div class="button-group" style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showAddEmployee()">+ æ–°å¢å“¡å·¥</button>
                </div>
                <div class="employee-grid" id="employeeGrid">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- ===== ç­æ¬¡è¨­å®š Tab ===== -->
        <div class="tab-content" id="tab-shifts">
            <div class="card">
                <h2>ç­æ¬¡è¨­å®š</h2>
                <p style="color:#666; margin-bottom:20px;">è¨­å®šæ¯å€‹ç­æ¬¡çš„æ™‚é–“å’Œäººæ•¸éœ€æ±‚</p>

                <div class="shift-list" id="shiftList">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="addShift()">+ æ–°å¢ç­æ¬¡</button>
                </div>
            </div>
        </div>

        <!-- ===== å‡æ—¥æ—¥æ›† Tab ===== -->
        <div class="tab-content" id="tab-calendar">
            <div class="card">
                <div class="calendar-header">
                    <h2>å‡æ—¥èˆ‡æ—ºæ—¥æ—¥æ›†</h2>
                    <div class="calendar-nav">
                        <button onclick="prevMonth()">&lt; ä¸Šå€‹æœˆ</button>
                        <span class="month-label" id="calendarMonthLabel">2025å¹´ 1æœˆ</span>
                        <button onclick="nextMonth()">ä¸‹å€‹æœˆ &gt;</button>
                    </div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- ===== æ—ºæ—¥è¨­å®š Tab ===== -->
        <div class="tab-content" id="tab-settings">
            <div class="card">
                <h2>æ—ºæ—¥åˆ¤å®šè¨­å®š</h2>
                <p style="color:#666; margin-bottom:20px;">å‹¾é¸å“ªäº›æƒ…æ³è¦è¦–ç‚ºæ—ºæ—¥ï¼ˆéœ€è¦æ›´å¤šäººæ‰‹ï¼‰</p>
                <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <input type="checkbox" id="peakWeekend" onchange="updateSettings('peakWeekend', this.checked)">
                    <label for="peakWeekend" style="margin-bottom: 0;">é€±å…­ã€é€±æ—¥è¦–ç‚ºæ—ºæ—¥</label>
                </div>
                <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <input type="checkbox" id="peakHoliday" onchange="updateSettings('peakHoliday', this.checked)">
                    <label for="peakHoliday" style="margin-bottom: 0;">åœ‹å®šå‡æ—¥è¦–ç‚ºæ—ºæ—¥</label>
                </div>
                <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <input type="checkbox" id="peakVacation" onchange="updateSettings('peakVacation', this.checked)">
                    <label for="peakVacation" style="margin-bottom: 0;">å¤§å­¸å¯’æš‘å‡æœŸé–“è¦–ç‚ºæ—ºæ—¥</label>
                </div>

                <h3 style="margin: 25px 0 15px 0; font-size: 16px;">å¯’æš‘å‡æ—¥æœŸè¨­å®š (114å­¸å¹´åº¦)</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label>å¯’å‡é–‹å§‹</label>
                        <input type="date" id="winterStart" onchange="updateVacation('winterStart', this.value)">
                    </div>
                    <div class="form-group">
                        <label>å¯’å‡çµæŸ</label>
                        <input type="date" id="winterEnd" onchange="updateVacation('winterEnd', this.value)">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æš‘å‡é–‹å§‹</label>
                        <input type="date" id="summerStart" onchange="updateVacation('summerStart', this.value)">
                    </div>
                    <div class="form-group">
                        <label>æš‘å‡çµæŸ</label>
                        <input type="date" id="summerEnd" onchange="updateVacation('summerEnd', this.value)">
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- å“¡å·¥ç·¨è¼¯å½ˆçª— -->
    <div class="modal" id="employeeModal">
        <div class="modal-content">
            <h3 id="employeeModalTitle">æ–°å¢å“¡å·¥</h3>
            <input type="hidden" id="editEmployeeId">
            <div class="form-group" style="margin-bottom: 15px;">
                <label>å§“å</label>
                <input type="text" id="empName" placeholder="è¼¸å…¥å“¡å·¥å§“å">
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label>é¡å‹</label>
                <select id="empType">
                    <option value="fulltime">æ­£è·</option>
                    <option value="parttime">å…¼è·</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>æ¯é€±æœ€å¤šå·¥ä½œå¤©æ•¸</label>
                    <input type="number" id="empMaxDays" min="1" max="7" value="5">
                </div>
                <div class="form-group">
                    <label>æ¯é€±æœ€å¤šå·¥ä½œå°æ™‚</label>
                    <input type="number" id="empMaxHours" min="1" max="168" value="40">
                </div>
            </div>
            <div class="form-group" style="margin-bottom: 15px;">
                <label>å¯ä¸Šç­æ—¥</label>
                <div class="week-selector" id="availableDays">
                    <button class="week-day-btn selected" data-day="1">é€±ä¸€</button>
                    <button class="week-day-btn selected" data-day="2">é€±äºŒ</button>
                    <button class="week-day-btn selected" data-day="3">é€±ä¸‰</button>
                    <button class="week-day-btn selected" data-day="4">é€±å››</button>
                    <button class="week-day-btn selected" data-day="5">é€±äº”</button>
                    <button class="week-day-btn selected" data-day="6">é€±å…­</button>
                    <button class="week-day-btn selected" data-day="0">é€±æ—¥</button>
                </div>
            </div>
            <div class="form-group">
                <label>åå¥½ç­æ¬¡</label>
                <div class="week-selector" id="preferredShifts">
                    <!-- å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="hideEmployeeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveEmployee()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="quickAddMenu" class="quick-add-menu"></div>

    <script>
        // ==================== è³‡æ–™å®šç¾© ====================

        // å°ç£ 2026 åœ‹å®šå‡æ—¥ (ç¯„ä¾‹)
        const taiwanHolidays = {
            "2026-01-01": "å…ƒæ—¦",
            "2026-02-16": "è¾²æ›†é™¤å¤•",
            "2026-02-17": "æ˜¥ç¯€",
            "2026-02-18": "æ˜¥ç¯€",
            "2026-02-19": "æ˜¥ç¯€",
            "2026-02-20": "æ˜¥ç¯€",
            "2026-02-28": "å’Œå¹³ç´€å¿µæ—¥",
            "2026-04-03": "å…’ç«¥ç¯€",
            "2026-04-04": "æ¸…æ˜ç¯€",
            "2026-04-06": "æ¸…æ˜ç¯€è£œå‡",
            "2026-05-01": "å‹å‹•ç¯€",
            "2026-06-19": "ç«¯åˆç¯€",
            "2026-09-25": "ä¸­ç§‹ç¯€",
            "2026-09-28": "æ•™å¸«ç¯€",
            "2026-10-09": "åœ‹æ…¶æ—¥è£œå‡",
            "2026-10-10": "åœ‹æ…¶æ—¥",
            "2026-10-25": "å°ç£å…‰å¾©ç¯€",
            "2026-10-26": "å…‰å¾©ç¯€è£œå‡",
            "2026-12-25": "è¡Œæ†²ç´€å¿µæ—¥",
        };

        // å¤§å­¸å¯’æš‘å‡ (114å­¸å¹´åº¦)
        let vacationDates = {
            winterStart: "2025-12-22",
            winterEnd: "2026-02-22",
            summerStart: "2026-07-01",
            summerEnd: "2026-08-31"
        };

        // ç­æ¬¡è¨­å®š
        let shifts = [
            { id: 1, name: "é–‹æ—©", start: "10:00", end: "15:00", normalStaff: 1, peakStaff: 1 },
            { id: 2, name: "ä¸‹åˆ", start: "15:00", end: "18:00", normalStaff: 1, peakStaff: 2 },
            { id: 3, name: "æ™šç­", start: "18:00", end: "22:00", normalStaff: 3, peakStaff: 5 },
            { id: 4, name: "æ”¶å°¾", start: "22:00", end: "01:00", normalStaff: 2, peakStaff: 3 },
        ];

        // å“¡å·¥è³‡æ–™
        let employees = [
            { id: 1, name: "å°æ˜", type: "fulltime", maxDays: 5, maxHours: 40, availableDays: [1,2,3,4,5], preferredShifts: [1,2,3,4] },
            { id: 2, name: "å°ç´…", type: "fulltime", maxDays: 5, maxHours: 40, availableDays: [1,2,3,4,5,6], preferredShifts: [1,2,3] },
            { id: 3, name: "é˜¿å¼·", type: "parttime", maxDays: 3, maxHours: 24, availableDays: [2,4,6,0], preferredShifts: [3,4] },
            { id: 4, name: "å°ç¾", type: "parttime", maxDays: 4, maxHours: 32, availableDays: [1,2,3,4,5,6,0], preferredShifts: [2,3] },
            { id: 5, name: "å¤§è¯", type: "fulltime", maxDays: 5, maxHours: 40, availableDays: [1,3,4,5,6,0], preferredShifts: [3,4] },
        ];

        let nextEmployeeId = 6;
        let nextShiftId = 5;

        // æ’ç­è³‡æ–™ { "2025-01-20": { 1: [empId, empId], 2: [empId] } }
        let schedule = {};

        // è¨­å®š
        let settings = {
            peakWeekend: true,
            peakHoliday: true,
            peakVacation: true
        };

        // ç•¶å‰é¡¯ç¤ºçš„é€±/æœˆ
        let currentWeekStart = getMonday(new Date());
        let currentMonth = new Date();
        let weatherData = {}; // å„²å­˜å¤©æ°£è³‡æ–™ { "2025-01-20": { tempMax, tempMin, code, pop } }

        // ==================== å·¥å…·å‡½æ•¸ ====================

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            const d = new Date(date);
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        function formatDateShort(date) {
            const d = new Date(date);
            return `${d.getMonth()+1}/${d.getDate()}`;
        }

        function getDayName(date) {
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            return days[new Date(date).getDay()];
        }

        function isPeakDay(dateStr) {
            const date = new Date(dateStr);
            const dayOfWeek = date.getDay();

            // é€±æœ«
            if (settings.peakWeekend && (dayOfWeek === 0 || dayOfWeek === 6)) {
                return true;
            }

            // åœ‹å®šå‡æ—¥
            if (settings.peakHoliday && taiwanHolidays[dateStr]) {
                return true;
            }

            // å¯’æš‘å‡
            if (settings.peakVacation) {
                if ((dateStr >= vacationDates.winterStart && dateStr <= vacationDates.winterEnd) ||
                    (dateStr >= vacationDates.summerStart && dateStr <= vacationDates.summerEnd)) {
                    return true;
                }
            }

            return false;
        }

        function getShiftHours(shift) {
            const start = shift.start.split(':').map(Number);
            const end = shift.end.split(':').map(Number);
            let hours = end[0] - start[0] + (end[1] - start[1]) / 60;
            if (hours <= 0) hours += 24; // è·¨å¤œ
            return hours;
        }

        // ==================== å¤©æ°£åŠŸèƒ½ ====================

        async function fetchWeather() {
            try {
                // å®œè˜­ç¾…æ±åº§æ¨™: 24.67, 121.76
                const url = `https://api.open-meteo.com/v1/forecast?latitude=24.67&longitude=121.76&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&past_days=7&timezone=Asia%2FTaipei`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data && data.daily) {
                    data.daily.time.forEach((time, index) => {
                        weatherData[time] = {
                            tempMax: data.daily.temperature_2m_max[index],
                            tempMin: data.daily.temperature_2m_min[index],
                            code: data.daily.weather_code[index],
                            pop: data.daily.precipitation_probability_max[index]
                        };
                    });
                }
            } catch (error) {
                console.error("ç„¡æ³•ç²å–å¤©æ°£è³‡æ–™:", error);
            }
        }

        function getWeatherIcon(code) {
            if (code === 0) return 'â˜€ï¸';
            if ([1, 2, 3].includes(code)) return 'â›…';
            if ([45, 48].includes(code)) return 'ğŸŒ«ï¸';
            if ([51, 53, 55, 56, 57].includes(code)) return 'ğŸŒ§ï¸';
            if ([61, 63, 65, 66, 67].includes(code)) return 'ğŸŒ§ï¸';
            if ([71, 73, 75, 77, 85, 86].includes(code)) return 'â„ï¸';
            if ([80, 81, 82].includes(code)) return 'ğŸŒ¦ï¸';
            if ([95, 96, 99].includes(code)) return 'â›ˆï¸';
            return 'â“';
        }

        // ==================== æ’ç­è¡¨æ¸²æŸ“ ====================

        async function renderScheduleTable() {
            if (Object.keys(weatherData).length === 0) {
                await fetchWeather();
            }
            const table = document.getElementById('scheduleTable');
            const weekDates = [];

            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                weekDates.push(formatDate(d));
            }

            // è¡¨é ­
            const monthLabel = (currentWeekStart.getMonth() + 1) + 'æœˆ';
            let html = `<thead><tr><th><div style="font-size:16px; color:#667eea; margin-bottom:4px;">${monthLabel}</div>ç­æ¬¡</th>`;
            weekDates.forEach(dateStr => {
                const isPeak = isPeakDay(dateStr);
                const isHoliday = taiwanHolidays[dateStr];
                const className = isHoliday ? 'holiday' : (isPeak ? 'peak' : '');
                const weather = weatherData[dateStr];
                let weatherHtml = '';
                if (weather) {
                    const popClass = weather.pop > 40 ? 'high-pop' : '';
                    weatherHtml = `
                    <div class="schedule-weather">
                        <div class="weather-main">
                            <span>${getWeatherIcon(weather.code)}</span>
                            <span>${Math.round(weather.tempMax)}Â°</span>
                        </div>
                        <div class="weather-detail">
                            <span>${Math.round(weather.tempMin)}Â°</span>
                            <span class="${popClass}">â˜”${weather.pop}%</span>
                        </div>
                    </div>`;
                }
                html += `<th class="${className}">
                    <div style="margin-bottom:4px;">é€±${getDayName(dateStr)}</div>
                    <div class="date-info" style="font-weight:bold; color:#333;">${formatDateShort(dateStr)}</div>
                    ${weatherHtml}
                    ${isHoliday ? `<div class="date-info" style="color:#e91e63; margin-top:2px;">${isHoliday}</div>` : ''}
                    ${isPeak && !isHoliday ? `<div class="date-info" style="color:#ff9800; margin-top:2px;">æ—ºæ—¥</div>` : ''}
                </th>`;
            });
            html += '</tr></thead>';

            // è¡¨èº«
            html += '<tbody>';
            shifts.forEach(shift => {
                html += `<tr><td class="shift-label">${shift.name}<br><span style="font-size:11px;color:#888">${shift.start} - ${shift.end}</span></td>`;

                weekDates.forEach(dateStr => {
                    const isPeak = isPeakDay(dateStr);
                    const required = isPeak ? shift.peakStaff : shift.normalStaff;
                    const assigned = (schedule[dateStr] && schedule[dateStr][shift.id]) || [];

                    html += `<td>
                        <div class="staff-tags">
                            ${assigned.map(empId => {
                                const emp = employees.find(e => e.id === empId);
                                if (!emp) return '';
                                return `<div class="staff-tag ${emp.type}" onclick="removeFromSchedule('${dateStr}', ${shift.id}, ${emp.id})" title="é»æ“Šç§»é™¤">${emp.name}</div>`;
                            }).join('')}
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                            ${assigned.length < required ? `<div class="need-more">é‚„éœ€ ${required - assigned.length} äºº</div>` : ''}
                            <div class="quick-add-btn" onclick="showQuickAddMenu(event, '${dateStr}', ${shift.id})" title="å¿«é€Ÿæ–°å¢äººå“¡">+</div>
                        </div>
                    </td>`;
                });

                html += '</tr>';
            });
            html += '</tbody>';

            table.innerHTML = html;
            updateWeekLabel();
            updateStats();
        }

        function updateWeekLabel() {
            const start = new Date(currentWeekStart);
            const end = new Date(start);
            end.setDate(end.getDate() + 6);
            document.getElementById('weekLabel').textContent =
                `${start.getFullYear()}/${String(start.getMonth()+1).padStart(2,'0')}/${String(start.getDate()).padStart(2,'0')} - ${String(end.getMonth()+1).padStart(2,'0')}/${String(end.getDate()).padStart(2,'0')}`;
        }

        function prevWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            renderScheduleTable();
        }

        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            renderScheduleTable();
        }

        // ==================== AI æ’ç­ ====================

        function generateAISchedule() {
            if (!confirm('AI å°‡ç‚ºæœ¬é€±ç”Ÿæˆæ’ç­ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ')) return;

            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                weekDates.push(formatDate(d));
            }

            // é‡ç½®æœ¬é€±æ’ç­
            weekDates.forEach(dateStr => {
                schedule[dateStr] = {};
                shifts.forEach(shift => {
                    schedule[dateStr][shift.id] = [];
                });
            });

            const empHours = {};
            const empDays = {};
            employees.forEach(emp => {
                empHours[emp.id] = 0;
                empDays[emp.id] = new Set();
            });

            weekDates.forEach(dateStr => {
                const dayOfWeek = new Date(dateStr).getDay();
                const isPeak = isPeakDay(dateStr);

                shifts.forEach(shift => {
                    const required = isPeak ? shift.peakStaff : shift.normalStaff;
                    const shiftHours = getShiftHours(shift);

                    const candidates = employees.filter(emp => {
                        if (!emp.availableDays.includes(dayOfWeek)) return false;
                        if (empHours[emp.id] + shiftHours > emp.maxHours) return false;
                        if (empDays[emp.id].size >= emp.maxDays && !empDays[emp.id].has(dateStr)) return false;
                        return true;
                    }).map(emp => {
                        let score = 0;
                        if (emp.type === 'fulltime') score += 100;
                        if (emp.preferredShifts.includes(shift.id)) score += 50;
                        const hoursRatio = empHours[emp.id] / emp.maxHours;
                        score += (1 - hoursRatio) * 30;
                        score += Math.random() * 10;
                        return { emp, score };
                    }).sort((a, b) => b.score - a.score);

                    let assigned = 0;
                    for (const { emp } of candidates) {
                        if (assigned >= required) break;
                        schedule[dateStr][shift.id].push(emp.id);
                        empHours[emp.id] += shiftHours;
                        empDays[emp.id].add(dateStr);
                        assigned++;
                    }
                });
            });

            renderScheduleTable();
            saveToLocalStorage();
            alert('AI æ’ç­å®Œæˆï¼');
        }

        // ==================== å“¡å·¥ç®¡ç† ====================

        function renderEmployees() {
            const grid = document.getElementById('employeeGrid');
            const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

            grid.innerHTML = employees.map(emp => `
                <div class="employee-card ${emp.type}">
                    <div class="actions">
                        <button onclick="editEmployee(${emp.id})" title="ç·¨è¼¯">âœï¸</button>
                        <button onclick="deleteEmployee(${emp.id})" title="åˆªé™¤">ğŸ—‘ï¸</button>
                    </div>
                    <div class="header">
                        <span class="name">${emp.name}</span>
                        <span class="type-badge ${emp.type}">${emp.type === 'fulltime' ? 'æ­£è·' : 'å…¼è·'}</span>
                    </div>
                    <div class="info">
                        æ¯é€±æœ€å¤š ${emp.maxDays} å¤© / ${emp.maxHours} å°æ™‚
                    </div>
                    <div class="availability">
                        ${[1,2,3,4,5,6,0].map(d => {
                            const available = emp.availableDays.includes(d);
                            return `<span class="day-chip ${available ? '' : 'unavailable'}">é€±${dayNames[d]}</span>`;
                        }).join('')}
                    </div>
                </div>
            `).join('');

            document.getElementById('employeeCount').textContent = employees.length + ' äºº';
        }

        function showAddEmployee() {
            document.getElementById('employeeModalTitle').textContent = 'æ–°å¢å“¡å·¥';
            document.getElementById('editEmployeeId').value = '';
            document.getElementById('empName').value = '';
            document.getElementById('empType').value = 'fulltime';
            document.getElementById('empMaxDays').value = 5;
            document.getElementById('empMaxHours').value = 40;
            document.querySelectorAll('#availableDays .week-day-btn').forEach(btn => btn.classList.add('selected'));
            renderShiftSelector();
            document.getElementById('employeeModal').classList.add('active');
        }

        function editEmployee(id) {
            const emp = employees.find(e => e.id === id);
            if (!emp) return;
            document.getElementById('employeeModalTitle').textContent = 'ç·¨è¼¯å“¡å·¥';
            document.getElementById('editEmployeeId').value = id;
            document.getElementById('empName').value = emp.name;
            document.getElementById('empType').value = emp.type;
            document.getElementById('empMaxDays').value = emp.maxDays;
            document.getElementById('empMaxHours').value = emp.maxHours;
            document.querySelectorAll('#availableDays .week-day-btn').forEach(btn => {
                const day = parseInt(btn.dataset.day);
                btn.classList.toggle('selected', emp.availableDays.includes(day));
            });
            renderShiftSelector(emp.preferredShifts);
            document.getElementById('employeeModal').classList.add('active');
        }

        function renderShiftSelector(selected = []) {
            const container = document.getElementById('preferredShifts');
            container.innerHTML = shifts.map(shift => `
                <button type="button" class="week-day-btn ${selected.includes(shift.id) ? 'selected' : ''}"
                        data-shift="${shift.id}">${shift.name}</button>
            `).join('');
            container.querySelectorAll('.week-day-btn').forEach(btn => {
                btn.addEventListener('click', () => btn.classList.toggle('selected'));
            });
        }

        function hideEmployeeModal() {
            document.getElementById('employeeModal').classList.remove('active');
        }

        function saveEmployee() {
            const id = document.getElementById('editEmployeeId').value;
            const name = document.getElementById('empName').value.trim();
            const type = document.getElementById('empType').value;
            const maxDays = parseInt(document.getElementById('empMaxDays').value);
            const maxHours = parseInt(document.getElementById('empMaxHours').value);

            if (!name) { alert('è«‹è¼¸å…¥å“¡å·¥å§“å'); return; }

            const availableDays = [];
            document.querySelectorAll('#availableDays .week-day-btn.selected').forEach(btn => {
                availableDays.push(parseInt(btn.dataset.day));
            });

            const preferredShifts = [];
            document.querySelectorAll('#preferredShifts .week-day-btn.selected').forEach(btn => {
                preferredShifts.push(parseInt(btn.dataset.shift));
            });

            if (id) {
                const emp = employees.find(e => e.id === parseInt(id));
                if (emp) {
                    emp.name = name; emp.type = type; emp.maxDays = maxDays;
                    emp.maxHours = maxHours; emp.availableDays = availableDays;
                    emp.preferredShifts = preferredShifts;
                }
            } else {
                employees.push({ id: nextEmployeeId++, name, type, maxDays, maxHours, availableDays, preferredShifts });
            }

            renderEmployees();
            renderScheduleTable();
            hideEmployeeModal();
            saveToLocalStorage();
        }

        function deleteEmployee(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ä½å“¡å·¥å—ï¼Ÿ')) return;
            employees = employees.filter(e => e.id !== id);
            for (let dateStr in schedule) {
                for (let shiftId in schedule[dateStr]) {
                    schedule[dateStr][shiftId] = schedule[dateStr][shiftId].filter(empId => empId !== id);
                }
            }
            renderEmployees();
            renderScheduleTable();
            saveToLocalStorage();
        }

        document.querySelectorAll('#availableDays .week-day-btn').forEach(btn => {
            btn.addEventListener('click', () => btn.classList.toggle('selected'));
        });

        // ==================== ç­æ¬¡è¨­å®š ====================

        function renderShifts() {
            const container = document.getElementById('shiftList');
            let html = `<div class="shift-item" style="background:#e8ebf2; font-weight:600;">
                <span></span>
                <span>ç­æ¬¡åç¨±</span>
                <span>é–‹å§‹æ™‚é–“</span>
                <span>çµæŸæ™‚é–“</span>
                <span>å¹³æ—¥äººæ•¸</span>
                <span>æ—ºæ—¥äººæ•¸</span>
                <span></span>
            </div>`;

            shifts.forEach((shift, index) => {
                html += `<div class="shift-item" draggable="true" data-index="${index}" ondragstart="handleDragStart(event)" ondragover="handleDragOver(event)" ondragend="handleDragEnd(event)" ondrop="handleDrop(event)">
                    <div class="drag-handle">â˜°</div>
                    <input type="text" value="${shift.name}" onchange="updateShift(${shift.id}, 'name', this.value)">
                    <input type="time" value="${shift.start}" onchange="updateShift(${shift.id}, 'start', this.value)">
                    <input type="time" value="${shift.end}" onchange="updateShift(${shift.id}, 'end', this.value)">
                    <input type="number" value="${shift.normalStaff}" min="1" onchange="updateShift(${shift.id}, 'normalStaff', parseInt(this.value))">
                    <input type="number" value="${shift.peakStaff}" min="1" onchange="updateShift(${shift.id}, 'peakStaff', parseInt(this.value))">
                    <button class="delete-btn" onclick="deleteShift(${shift.id})">åˆªé™¤</button>
                </div>`;
            });
            container.innerHTML = html;
        }

        function addShift() {
            shifts.push({ id: nextShiftId++, name: "æ–°ç­æ¬¡", start: "09:00", end: "17:00", normalStaff: 1, peakStaff: 1 });
            renderShifts();
            renderScheduleTable();
            saveToLocalStorage();
        }

        function updateShift(id, field, value) {
            const shift = shifts.find(s => s.id === id);
            if (shift) {
                shift[field] = value;
                renderScheduleTable();
                saveToLocalStorage();
            }
        }

        function deleteShift(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ç­æ¬¡å—ï¼Ÿ')) return;
            shifts = shifts.filter(s => s.id !== id);
            renderShifts();
            renderScheduleTable();
            saveToLocalStorage();
        }

        // æ‹–æ›³æ’åº
        let dragSrcIndex = null;
        function handleDragStart(e) {
            dragSrcIndex = e.target.dataset.index;
            e.target.classList.add('dragging');
        }
        function handleDragOver(e) { e.preventDefault(); }
        function handleDragEnd(e) { e.target.classList.remove('dragging'); }
        function handleDrop(e) {
            e.preventDefault();
            const targetIndex = e.target.closest('.shift-item').dataset.index;
            if (dragSrcIndex !== null && targetIndex !== undefined && dragSrcIndex !== targetIndex) {
                const [movedItem] = shifts.splice(dragSrcIndex, 1);
                shifts.splice(targetIndex, 0, movedItem);
                renderShifts();
                renderScheduleTable();
                saveToLocalStorage();
            }
        }

        // ==================== çµ±è¨ˆ ====================

        function updateStats() {
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                weekDates.push(formatDate(d));
            }

            const dailyStats = {};
            weekDates.forEach(dateStr => {
                dailyStats[dateStr] = 0;
                if (schedule[dateStr]) {
                    shifts.forEach(shift => {
                        const assigned = schedule[dateStr][shift.id] || [];
                        const hours = getShiftHours(shift);
                        dailyStats[dateStr] += assigned.length * hours;
                    });
                }
            });

            const grid = document.getElementById('statsGrid');
            grid.innerHTML = weekDates.map(dateStr => {
                const isPeak = isPeakDay(dateStr);
                const isHoliday = taiwanHolidays[dateStr];
                const label = `é€±${getDayName(dateStr)} (${formatDateShort(dateStr)})`;
                const hours = dailyStats[dateStr].toFixed(1);
                return `
                    <div class="stat-card" style="${isHoliday ? 'border-top: 3px solid #e91e63;' : (isPeak ? 'border-top: 3px solid #ff9800;' : '')}">
                        <div class="name">${label}</div>
                        <div class="hours">${hours}<small>h</small></div>
                        <div class="days" style="font-size: 11px; color: #888;">ç•¶æ—¥ç¸½å·¥æ™‚</div>
                    </div>
                `;
            }).join('');
        }

        // ==================== æ’ç­æ“ä½œ ====================

        function removeFromSchedule(dateStr, shiftId, empId) {
            if (!schedule[dateStr]) return;
            schedule[dateStr][shiftId] = schedule[dateStr][shiftId].filter(id => id !== empId);
            renderScheduleTable();
            saveToLocalStorage();
        }

        function showQuickAddMenu(event, dateStr, shiftId) {
            event.stopPropagation();
            const menu = document.getElementById('quickAddMenu');
            const assigned = (schedule[dateStr] && schedule[dateStr][shiftId]) || [];
            const candidates = employees.filter(emp => !assigned.includes(emp.id));
            
            if (candidates.length === 0) { alert('æ‰€æœ‰å“¡å·¥çš†å·²åœ¨æ­¤ç­æ¬¡ä¸­'); return; }

            menu.innerHTML = candidates.map(emp => `
                <div class="quick-add-item ${emp.type}" onclick="quickAddEmployee('${dateStr}', ${shiftId}, ${emp.id})">
                    <div class="type-dot"></div>
                    <span>${emp.name}</span>
                    <span style="font-size: 10px; color: #94a3b8; margin-left: auto;">${emp.type === 'fulltime' ? 'æ­£è·' : 'å…¼è·'}</span>
                </div>
            `).join('');

            menu.style.display = 'block';
            const rect = event.target.getBoundingClientRect();
            menu.style.top = (rect.bottom + window.scrollY + 5) + 'px';
            menu.style.left = (rect.left + window.scrollX) + 'px';
        }

        function quickAddEmployee(dateStr, shiftId, empId) {
            if (!schedule[dateStr]) schedule[dateStr] = {};
            if (!schedule[dateStr][shiftId]) schedule[dateStr][shiftId] = [];
            if (!schedule[dateStr][shiftId].includes(empId)) {
                schedule[dateStr][shiftId].push(empId);
                renderScheduleTable();
                saveToLocalStorage();
            }
            document.getElementById('quickAddMenu').style.display = 'none';
        }

        // ==================== æ—¥æ›†åŠŸèƒ½ ====================

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const label = document.getElementById('calendarMonthLabel');
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            label.textContent = `${year}å¹´ ${month + 1}æœˆ`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const totalDays = lastDay.getDate();

            let html = `
                <div class="day-header">æ—¥</div><div class="day-header">ä¸€</div>
                <div class="day-header">äºŒ</div><div class="day-header">ä¸‰</div>
                <div class="day-header">å››</div><div class="day-header">äº”</div>
                <div class="day-header">å…­</div>
            `;

            for (let i = 0; i < startDay; i++) html += '<div class="day-cell other-month"></div>';

            for (let day = 1; day <= totalDays; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDate(date);
                const isPeak = isPeakDay(dateStr);
                const holiday = taiwanHolidays[dateStr];
                const isToday = formatDate(new Date()) === dateStr;

                html += `
                    <div class="day-cell ${isToday ? 'today' : ''} ${holiday ? 'holiday' : (isPeak ? 'peak' : '')}">
                        <div class="date">
                            ${day}
                            ${holiday ? `<span class="holiday-name">${holiday}</span>` : (isPeak ? '<span class="peak-badge">æ—º</span>' : '')}
                        </div>
                    </div>
                `;
            }
            grid.innerHTML = html;
        }

        function prevMonth() { currentMonth.setMonth(currentMonth.getMonth() - 1); renderCalendar(); }
        function nextMonth() { currentMonth.setMonth(currentMonth.getMonth() + 1); renderCalendar(); }

        // ==================== è¨­å®šèˆ‡å„²å­˜ ====================

        function updateSettings(key, value) { settings[key] = value; saveToLocalStorage(); renderScheduleTable(); renderCalendar(); }
        function updateVacation(key, value) { vacationDates[key] = value; saveToLocalStorage(); renderScheduleTable(); renderCalendar(); }

        function saveToLocalStorage() {
            localStorage.setItem('restaurant_employees', JSON.stringify(employees));
            localStorage.setItem('restaurant_shifts', JSON.stringify(shifts));
            localStorage.setItem('restaurant_schedule', JSON.stringify(schedule));
            localStorage.setItem('restaurant_settings', JSON.stringify(settings));
            localStorage.setItem('restaurant_vacation', JSON.stringify(vacationDates));
        }

        function loadFromLocalStorage() {
            const e = localStorage.getItem('restaurant_employees'); if (e) employees = JSON.parse(e);
            const s = localStorage.getItem('restaurant_shifts'); if (s) shifts = JSON.parse(s);
            const sc = localStorage.getItem('restaurant_schedule'); if (sc) schedule = JSON.parse(sc);
            const st = localStorage.getItem('restaurant_settings'); if (st) settings = JSON.parse(st);
            const v = localStorage.getItem('restaurant_vacation'); if (v) vacationDates = JSON.parse(v);
            
            if (employees.length > 0) nextEmployeeId = Math.max(...employees.map(emp => emp.id)) + 1;
            if (shifts.length > 0) nextShiftId = Math.max(...shifts.map(sh => sh.id)) + 1;
            
            document.getElementById('peakWeekend').checked = settings.peakWeekend;
            document.getElementById('peakHoliday').checked = settings.peakHoliday;
            document.getElementById('peakVacation').checked = settings.peakVacation;
            document.getElementById('winterStart').value = vacationDates.winterStart;
            document.getElementById('winterEnd').value = vacationDates.winterEnd;
            document.getElementById('summerStart').value = vacationDates.summerStart;
            document.getElementById('summerEnd').value = vacationDates.summerEnd;
        }

        function clearWeekSchedule() {
            if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæœ¬é€±æ’ç­å—ï¼Ÿ')) return;
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                delete schedule[formatDate(d)];
            }
            renderScheduleTable();
            saveToLocalStorage();
        }

        function saveSchedule() { saveToLocalStorage(); alert('æ’ç­å·²å„²å­˜ï¼'); }

        function exportCSV() {
            const weekDates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                weekDates.push(formatDate(d));
            }
            let csv = 'ç­æ¬¡,' + weekDates.map(d => `é€±${getDayName(d)} ${formatDateShort(d)}`).join(',') + '\n';
            shifts.forEach(shift => {
                let row = [shift.name + ' ' + shift.start + '-' + shift.end];
                weekDates.forEach(dateStr => {
                    const assigned = (schedule[dateStr] && schedule[dateStr][shift.id]) || [];
                    const names = assigned.map(id => {
                        const emp = employees.find(e => e.id === id);
                        return emp ? emp.name : '';
                    }).join(' ');
                    row.push(names);
                });
                csv += row.join(',') + '\n';
            });
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `æ’ç­è¡¨_${formatDate(currentWeekStart)}.csv`; a.click();
            URL.revokeObjectURL(url);
        }

        // ==================== åˆå§‹åŒ– ====================

        function init() {
            loadFromLocalStorage();
            renderEmployees();
            renderShifts();
            renderScheduleTable();
            renderCalendar();
        }

        // Tab åˆ‡æ›
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        // é»æ“Šå¤–éƒ¨é—œé–‰é¸å–®
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('quickAddMenu');
            if (menu && !e.target.closest('.quick-add-btn') && !e.target.closest('.quick-add-menu')) {
                menu.style.display = 'none';
            }
        });

        init();
    </script>
</body>
</html>
