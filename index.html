<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å»³ AI æ’ç­ç³»çµ± - å®œè˜­ç¾…æ±åº—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* é ‚éƒ¨å°èˆª */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .navbar h1 {
            font-size: 22px;
        }

        .navbar .store-name {
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        /* Tab å°èˆª */
        .tabs {
            background: white;
            display: flex;
            border-bottom: 2px solid #e8ebf2;
            padding: 0 20px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* ä¸»å…§å®¹å€ */
        .main-content {
            padding: 25px;
            max-width: 1800px; /* åŠ å¤§æœ€å¤§å¯¬åº¦ */
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .card h2 {
            font-size: 20px; /* åŠ å¤§æ¨™é¡Œ */
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* æ’ç­è¡¨æ¨£å¼å„ªåŒ– - åŠ å¤§ç‰ˆ */
        .month-label {
            font-size: 2rem; /* åŠ å¤§æœˆä»½å­—é«” */
            font-weight: 800;
            color: #2b6cb0;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            table-layout: fixed;
        }

        .schedule-table th, .schedule-table td {
            border: 1px solid #e2e8f0;
            padding: 20px 12px; /* å¢åŠ å…§è· */
            text-align: center;
            vertical-align: top;
            min-height: 140px; /* å¢åŠ æœ€å°é«˜åº¦ */
        }

        .schedule-table th {
            background: #f8f9fc;
            font-weight: 700;
            color: #4a5568;
            font-size: 1.1rem; /* åŠ å¤§è¡¨é ­å­—é«” */
        }

        .schedule-table td.peak-day {
            background-color: #fffaf0;
        }

        .schedule-table td.holiday-day {
            background-color: #fff5f5;
        }

        .shift-label {
            font-weight: 700;
            color: #2d3748;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .shift-time {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 10px;
        }

        .employee-tag {
            display: inline-flex;
            align-items: center;
            background: #edf2f7;
            padding: 6px 12px; /* åŠ å¤§æ¨™ç±¤ */
            border-radius: 6px;
            margin: 4px;
            font-size: 15px; /* åŠ å¤§å­—é«” */
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: relative;
        }

        .employee-tag.fulltime {
            border-left: 4px solid #48bb78;
        }

        .employee-tag.parttime {
            border-left: 4px solid #ecc94b;
        }

        .remove-btn {
            margin-left: 6px;
            cursor: pointer;
            color: #a0aec0;
            font-weight: bold;
        }

        .remove-btn:hover {
            color: #e53e3e;
        }

        .quick-add-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px; /* åŠ å¤§æŒ‰éˆ• */
            height: 32px;
            background: #4299e1;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            margin: 12px auto;
            display: block;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.3);
        }

        .quick-add-btn:hover {
            background: #3182ce;
            transform: scale(1.1);
        }

        .need-more {
            color: #e53e3e;
            font-size: 0.9rem;
            margin-top: 8px;
            font-weight: 600;
        }

        /* å¤©æ°£æ¨£å¼ */
        .schedule-weather {
            font-size: 12px;
            margin: 8px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: rgba(255, 255, 255, 0.7);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .weather-main {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .weather-detail {
            display: flex;
            gap: 8px;
            font-size: 11px;
            color: #4a5568;
        }

        .high-pop {
            color: #e53e3e !important;
            font-weight: 800;
        }

        /* å¿«é€Ÿæ–°å¢é¸å–® */
        .quick-add-menu {
            position: fixed;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 1000;
            padding: 12px;
            min-width: 180px;
            display: none;
            border: 1px solid #e2e8f0;
        }

        .quick-add-item {
            padding: 10px 15px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quick-add-item:hover {
            background: #f7fafc;
            color: #3182ce;
        }

        /* æ¯æ—¥ç¸½å·¥æ™‚çµ±è¨ˆ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: #f8f9fc;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-card.peak { background-color: #fffaf0; border-color: #fbd38d; }
        .stat-card.holiday { background-color: #fff5f5; border-color: #feb2b2; }

        .stat-value {
            font-size: 24px;
            font-weight: 800;
            color: #2d3748;
            margin: 5px 0;
        }

        .stat-label {
            font-size: 13px;
            color: #718096;
            font-weight: 600;
        }

        /* å…¶ä»–åŸæœ‰æ¨£å¼ä¿æŒ... (ç°¡åŒ–ä»¥ç¯€çœç©ºé–“) */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-danger { background: #e53e3e; color: white; }
        .btn-success { background: #48bb78; color: white; }
        
        .ai-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 30px;
            color: white;
            margin-bottom: 20px;
        }
        .btn-ai {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }

        /* ç­æ¬¡è¨­å®šåˆ—è¡¨ */
        .shift-item {
            display: grid;
            grid-template-columns: 40px 2fr 1.5fr 1.5fr 1fr 1fr 100px;
            gap: 15px;
            align-items: center;
            padding: 15px;
            background: white;
            border-bottom: 1px solid #edf2f7;
        }
        .drag-handle { cursor: grab; font-size: 20px; color: #cbd5e0; }

        /* å“¡å·¥ç®¡ç† */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .employee-card {
            background: #f8f9fc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>é¤å»³ AI æ’ç­ç³»çµ±</h1>
        <div class="store-name">å®œè˜­ç¾…æ±åº—</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('schedule')">æ’ç­è¡¨</div>
        <div class="tab" onclick="switchTab('employees')">å“¡å·¥ç®¡ç†</div>
        <div class="tab" onclick="switchTab('shifts')">ç­æ¬¡è¨­å®š</div>
        <div class="tab" onclick="switchTab('holidays')">å‡æ—¥æ—¥æ›†</div>
        <div class="tab" onclick="switchTab('peak-settings')">æ—ºæ—¥è¨­å®š</div>
    </div>

    <div class="main-content">
        <!-- æ’ç­è¡¨åˆ†é  -->
        <div id="schedule" class="tab-content active">
            <div class="ai-section">
                <h2>AI æ™ºèƒ½æ’ç­</h2>
                <p>æ ¹æ“šå“¡å·¥å¯ç”¨æ™‚æ®µã€æ—ºæ—¥/å¹³æ—¥éœ€æ±‚ã€ä»¥åŠå°ç£åœ‹å®šå‡æ—¥è‡ªå‹•ç”Ÿæˆæœ€ä½³æ’ç­</p>
                <button class="btn-ai" onclick="runAIScheduling()">é–‹å§‹ AI æ’ç­</button>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>æœ¬é€±æ’ç­è¡¨</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn" style="background:#edf2f7" onclick="changeWeek(-1)">&lt; ä¸Šé€±</button>
                        <span id="current-week-label" style="font-weight: 700; font-size: 1.1rem;"></span>
                        <button class="btn" style="background:#edf2f7" onclick="changeWeek(1)">ä¸‹é€± &gt;</button>
                    </div>
                </div>
                
                <div id="schedule-container">
                    <!-- è¡¨æ ¼å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>

                <div style="margin-top: 25px; display: flex; gap: 15px;">
                    <button class="btn btn-success" onclick="saveSchedule()">å„²å­˜æ’ç­</button>
                    <button class="btn" style="background:#edf2f7" onclick="exportCSV()">åŒ¯å‡º CSV</button>
                    <button class="btn btn-danger" onclick="clearWeekSchedule()">æ¸…ç©ºæœ¬é€±</button>
                </div>
            </div>

            <div class="card">
                <h2>æ¯æ—¥ç¸½å·¥æ™‚çµ±è¨ˆ</h2>
                <div id="daily-stats" class="stats-grid">
                    <!-- çµ±è¨ˆå°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- å“¡å·¥ç®¡ç†åˆ†é  -->
        <div id="employees" class="tab-content">
            <div class="card">
                <h2>æ–°å¢å“¡å·¥</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label>å§“å</label>
                        <input type="text" id="emp-name" placeholder="è¼¸å…¥å§“å">
                    </div>
                    <div class="form-group">
                        <label>é¡å‹</label>
                        <select id="emp-type">
                            <option value="fulltime">æ­£è·</option>
                            <option value="parttime">å…¼è·</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ¯é€±æœ€å¤šå·¥ä½œå¤©æ•¸</label>
                        <input type="number" id="emp-max-days" value="5">
                    </div>
                    <div class="form-group">
                        <label>æ¯é€±æœ€å¤šå·¥ä½œå°æ™‚</label>
                        <input type="number" id="emp-max-hours" value="40">
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="font-size: 13px; font-weight: 500; color: #555;">å¯ç”¨æ™‚æ®µ (å‹¾é¸å¯ä¸Šç­çš„æ—¥å­)</label>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <label><input type="checkbox" class="emp-avail" value="1" checked> é€±ä¸€</label>
                        <label><input type="checkbox" class="emp-avail" value="2" checked> é€±äºŒ</label>
                        <label><input type="checkbox" class="emp-avail" value="3" checked> é€±ä¸‰</label>
                        <label><input type="checkbox" class="emp-avail" value="4" checked> é€±å››</label>
                        <label><input type="checkbox" class="emp-avail" value="5" checked> é€±äº”</label>
                        <label><input type="checkbox" class="emp-avail" value="6" checked> é€±å…­</label>
                        <label><input type="checkbox" class="emp-avail" value="0" checked> é€±æ—¥</label>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addEmployee()">æ–°å¢å“¡å·¥</button>
            </div>

            <div class="card">
                <h2>å“¡å·¥åˆ—è¡¨ <span id="emp-count" class="badge">0</span></h2>
                <div id="employee-list" class="employee-grid"></div>
            </div>
        </div>

        <!-- ç­æ¬¡è¨­å®šåˆ†é  -->
        <div id="shifts" class="tab-content">
            <div class="card">
                <h2>ç­æ¬¡è¨­å®š (å¯æ‹–æ›³æ’åº)</h2>
                <div id="shift-list" class="shift-list">
                    <!-- ç­æ¬¡å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
                <button class="btn btn-primary" style="margin-top: 20px;" onclick="addShift()">æ–°å¢ç­æ¬¡</button>
            </div>
        </div>

        <!-- å‡æ—¥æ—¥æ›†åˆ†é  -->
        <div id="holidays" class="tab-content">
            <div class="card">
                <div class="calendar-header">
                    <h2>å‡æ—¥æ—¥æ›†</h2>
                    <div class="calendar-nav">
                        <button onclick="changeCalendarMonth(-1)">&lt;</button>
                        <div id="calendar-month-label" class="month-label" style="margin-bottom:0; font-size:1.2rem">2025å¹´ 1æœˆ</div>
                        <button onclick="changeCalendarMonth(1)">&gt;</button>
                    </div>
                </div>
                <div id="calendar-grid" class="calendar-grid">
                    <div class="day-header">æ—¥</div>
                    <div class="day-header">ä¸€</div>
                    <div class="day-header">äºŒ</div>
                    <div class="day-header">ä¸‰</div>
                    <div class="day-header">å››</div>
                    <div class="day-header">äº”</div>
                    <div class="day-header">å…­</div>
                    <!-- æ—¥æœŸå°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- æ—ºæ—¥è¨­å®šåˆ†é  -->
        <div id="peak-settings" class="tab-content">
            <div class="card">
                <h2>æ—ºæ—¥åˆ¤å®šè¨­å®š</h2>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <label><input type="checkbox" id="peak-weekend" checked> é€±å…­ã€é€±æ—¥è¦–ç‚ºæ—ºæ—¥</label>
                    <label><input type="checkbox" id="peak-holiday" checked> åœ‹å®šå‡æ—¥è¦–ç‚ºæ—ºæ—¥</label>
                    <label><input type="checkbox" id="peak-vacation" checked> å¤§å­¸å¯’æš‘å‡æœŸé–“è¦–ç‚ºæ—ºæ—¥</label>
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿæ–°å¢å“¡å·¥é¸å–® -->
    <div id="quick-add-menu" class="quick-add-menu"></div>

    <script>
        // --- è³‡æ–™åˆå§‹åŒ– ---
        let employees = JSON.parse(localStorage.getItem('employees')) || [
            { id: 1, name: 'ç‹å¤§æ˜', type: 'fulltime', maxDays: 5, maxHours: 40, availability: [1,2,3,4,5,6,0], preferences: [] },
            { id: 2, name: 'æå°è¯', type: 'fulltime', maxDays: 5, maxHours: 40, availability: [1,2,3,4,5,6,0], preferences: [] },
            { id: 3, name: 'å¼µä¸‰', type: 'parttime', maxDays: 3, maxHours: 24, availability: [5,6,0], preferences: [] },
            { id: 4, name: 'é™³å››', type: 'parttime', maxDays: 4, maxHours: 32, availability: [1,2,3,6,0], preferences: [] },
            { id: 5, name: 'æ—äº”', type: 'fulltime', maxDays: 5, maxHours: 40, availability: [1,2,3,4,5], preferences: [] }
        ];

        let shifts = JSON.parse(localStorage.getItem('shifts')) || [
            { id: 1, name: 'é–‹æ—©', startTime: '10:00', endTime: '15:00', normalNeed: 1, peakNeed: 2 },
            { id: 2, name: 'ä¸‹åˆ', startTime: '15:00', endTime: '18:00', normalNeed: 2, peakNeed: 3 },
            { id: 3, name: 'æ™šç­', startTime: '18:00', endTime: '22:00', normalNeed: 5, peakNeed: 7 },
            { id: 4, name: 'æ”¶å°¾', startTime: '22:00', endTime: '01:00', normalNeed: 3, peakNeed: 4 }
        ];

        let schedules = JSON.parse(localStorage.getItem('schedules')) || {};
        let weatherData = {};

        // å°ç£ 2025 åœ‹å®šå‡æ—¥ (ç¯„ä¾‹)
        const holidays2025 = {
            '2025-01-01': 'å…ƒæ—¦',
            '2025-01-27': 'é™¤å¤•å‰ä¸€æ—¥',
            '2025-01-28': 'é™¤å¤•',
            '2025-01-29': 'æ˜¥ç¯€',
            '2025-01-30': 'æ˜¥ç¯€',
            '2025-01-31': 'æ˜¥ç¯€',
            '2025-02-28': 'å’Œå¹³ç´€å¿µæ—¥',
            '2025-04-03': 'å…’ç«¥ç¯€',
            '2025-04-04': 'æ¸…æ˜ç¯€',
            '2025-05-31': 'ç«¯åˆç¯€',
            '2025-10-06': 'ä¸­ç§‹ç¯€',
            '2025-10-10': 'åœ‹æ…¶æ—¥'
        };

        let currentWeekStart = getMonday(new Date());
        let calendarDate = new Date();

        // --- æ ¸å¿ƒåŠŸèƒ½ ---

        function init() {
            renderEmployeeList();
            renderShiftList();
            renderScheduleTable();
            fetchWeather();
            
            // é»æ“Šå¤–éƒ¨é—œé–‰å¿«é€Ÿæ–°å¢é¸å–®
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.quick-add-btn') && !e.target.closest('.quick-add-menu')) {
                    document.getElementById('quick-add-menu').style.display = 'none';
                }
            });
        }

        function getMonday(d) {
            d = new Date(d);
            let day = d.getDay(),
                diff = d.getDate() - day + (day == 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        async function fetchWeather() {
            try {
                // å®œè˜­ç¾…æ±åº§æ¨™: 24.67, 121.76
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=24.67&longitude=121.76&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTaipei&past_days=7');
                const data = await response.json();
                
                data.daily.time.forEach((dateStr, index) => {
                    weatherData[dateStr] = {
                        code: data.daily.weathercode[index],
                        maxTemp: data.daily.temperature_2m_max[index],
                        minTemp: data.daily.temperature_2m_min[index],
                        pop: data.daily.precipitation_probability_max[index]
                    };
                });
                renderScheduleTable();
            } catch (e) { console.error("Weather fetch failed", e); }
        }

        function getWeatherEmoji(code) {
            if (code <= 1) return 'â˜€ï¸';
            if (code <= 3) return 'â›…';
            if (code <= 48) return 'ğŸŒ«ï¸';
            if (code <= 67) return 'ğŸŒ§ï¸';
            if (code <= 77) return 'â„ï¸';
            if (code <= 82) return 'ğŸŒ¦ï¸';
            if (code <= 99) return 'â›ˆï¸';
            return 'â“';
        }

        function isPeakDay(date) {
            const dateStr = date.toISOString().split('T')[0];
            const day = date.getDay();
            
            if (document.getElementById('peak-weekend').checked && (day === 0 || day === 6)) return true;
            if (document.getElementById('peak-holiday').checked && holidays2025[dateStr]) return true;
            
            // å¯’æš‘å‡åˆ¤å®š (ç¯„ä¾‹)
            if (document.getElementById('peak-vacation').checked) {
                const month = date.getMonth() + 1;
                if (month === 1 || month === 2 || month === 7 || month === 8) return true;
            }
            return false;
        }

        function renderScheduleTable() {
            const container = document.getElementById('schedule-container');
            const weekLabel = document.getElementById('current-week-label');
            
            const start = new Date(currentWeekStart);
            const end = new Date(start);
            end.setDate(end.getDate() + 6);
            weekLabel.innerText = `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;

            // æœˆä»½æ¨™ç±¤
            const monthName = (start.getMonth() + 1) + "æœˆ";
            
            let html = `<div class="month-label">${monthName}</div>`;
            html += `<table class="schedule-table"><thead><tr><th>ç­æ¬¡</th>`;
            
            const days = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'];
            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const isPeak = isPeakDay(d);
                const holiday = holidays2025[dateStr];
                const weather = weatherData[dateStr];

                html += `<th class="${isPeak ? 'peak-day' : ''} ${holiday ? 'holiday-day' : ''}">
                    <div>${days[i]}</div>
                    <div style="font-size:0.8rem; color:#718096">${(d.getMonth()+1)}/${d.getDate()}</div>`;
                
                if (weather) {
                    html += `<div class="schedule-weather">
                        <div class="weather-main">${getWeatherEmoji(weather.code)} ${Math.round(weather.maxTemp)}Â°</div>
                        <div class="weather-detail">
                            <span>${Math.round(weather.minTemp)}Â°</span>
                            <span class="${weather.pop > 40 ? 'high-pop' : ''}">â˜”${weather.pop}%</span>
                        </div>
                    </div>`;
                }
                
                if (holiday) html += `<div style="color:#e53e3e; font-size:10px">${holiday}</div>`;
                if (isPeak) html += `<div style="color:#ed8936; font-size:10px">æ—ºæ—¥</div>`;
                
                html += `</th>`;
            }
            html += `</tr></thead><tbody>`;

            shifts.forEach(shift => {
                html += `<tr>
                    <td>
                        <div class="shift-label">${shift.name}</div>
                        <div class="shift-time">${shift.startTime} - ${shift.endTime}</div>
                    </td>`;
                
                for (let i = 0; i < 7; i++) {
                    const d = new Date(start);
                    d.setDate(d.getDate() + i);
                    const dateStr = d.toISOString().split('T')[0];
                    const isPeak = isPeakDay(d);
                    const need = isPeak ? shift.peakNeed : shift.normalNeed;
                    
                    const key = `${dateStr}_${shift.id}`;
                    const assigned = schedules[key] || [];
                    
                    html += `<td class="${isPeak ? 'peak-day' : ''}">
                        <div id="cell-${key}" class="cell-content">`;
                    
                    assigned.forEach(empId => {
                        const emp = employees.find(e => e.id == empId);
                        if (emp) {
                            html += `<span class="employee-tag ${emp.type}">
                                ${emp.name}
                                <span class="remove-btn" onclick="removeFromShift('${key}', ${emp.id})">Ã—</span>
                            </span>`;
                        }
                    });

                    html += `</div>`;
                    if (assigned.length < need) {
                        html += `<div class="need-more">é‚„éœ€ ${need - assigned.length} äºº</div>`;
                    }
                    html += `<div class="quick-add-btn" onclick="showQuickAdd(event, '${key}')">+</div>`;
                    html += `</td>`;
                }
                html += `</tr>`;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
            updateStats();
        }

        function showQuickAdd(event, key) {
            event.stopPropagation();
            const menu = document.getElementById('quick-add-menu');
            const assigned = schedules[key] || [];
            
            let html = `<div style="font-weight:bold; margin-bottom:8px; padding:0 5px; color:#4a5568; font-size:13px">å¿«é€Ÿæ–°å¢äººå“¡</div>`;
            
            employees.forEach(emp => {
                if (!assigned.includes(emp.id)) {
                    html += `<div class="quick-add-item" onclick="addToShift('${key}', ${emp.id})">
                        <span>${emp.name}</span>
                        <span style="font-size:10px; color:#aaa">${emp.type === 'fulltime' ? 'æ­£è·' : 'å…¼è·'}</span>
                    </div>`;
                }
            });

            if (employees.length === assigned.length) {
                html += `<div style="padding:10px; color:#999; font-size:12px">ç„¡å¯ç”¨äººå“¡</div>`;
            }

            menu.innerHTML = html;
            menu.style.display = 'block';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
        }

        function addToShift(key, empId) {
            if (!schedules[key]) schedules[key] = [];
            if (!schedules[key].includes(empId)) {
                schedules[key].push(empId);
                renderScheduleTable();
            }
            document.getElementById('quick-add-menu').style.display = 'none';
        }

        function removeFromShift(key, empId) {
            if (schedules[key]) {
                schedules[key] = schedules[key].filter(id => id != empId);
                renderScheduleTable();
            }
        }

        function updateStats() {
            const statsContainer = document.getElementById('daily-stats');
            const start = new Date(currentWeekStart);
            const days = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'];
            
            let html = '';
            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const isPeak = isPeakDay(d);
                const holiday = holidays2025[dateStr];
                
                let dailyHours = 0;
                shifts.forEach(shift => {
                    const key = `${dateStr}_${shift.id}`;
                    const assigned = schedules[key] || [];
                    
                    // è¨ˆç®—ç­æ¬¡æ™‚æ•¸
                    let startH = parseInt(shift.startTime.split(':')[0]);
                    let endH = parseInt(shift.endTime.split(':')[0]);
                    if (endH < startH) endH += 24; // è·¨å¤œ
                    const duration = endH - startH;
                    
                    dailyHours += assigned.length * duration;
                });

                html += `<div class="stat-card ${isPeak ? 'peak' : ''} ${holiday ? 'holiday' : ''}">
                    <div class="stat-label">${days[i]} (${(d.getMonth()+1)}/${d.getDate()})</div>
                    <div class="stat-value">${dailyHours.toFixed(1)}h</div>
                    <div class="stat-label">ç•¶æ—¥ç¸½å·¥æ™‚</div>
                </div>`;
            }
            statsContainer.innerHTML = html;
        }

        // --- å…¶ä»–è¼”åŠ©åŠŸèƒ½ (åˆ‡æ›é€±ã€å„²å­˜ã€å“¡å·¥ç®¡ç†ç­‰) ---
        function changeWeek(offset) {
            currentWeekStart.setDate(currentWeekStart.getDate() + (offset * 7));
            renderScheduleTable();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            if (tabId === 'holidays') renderCalendar();
        }

        function saveSchedule() {
            localStorage.setItem('schedules', JSON.stringify(schedules));
            alert('æ’ç­å·²å„²å­˜ï¼');
        }

        function clearWeekSchedule() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæœ¬é€±æ‰€æœ‰æ’ç­å—ï¼Ÿ')) {
                const start = new Date(currentWeekStart);
                for (let i = 0; i < 7; i++) {
                    const d = new Date(start);
                    d.setDate(d.getDate() + i);
                    const dateStr = d.toISOString().split('T')[0];
                    shifts.forEach(s => delete schedules[`${dateStr}_${s.id}`]);
                }
                renderScheduleTable();
            }
        }

        // --- ç­æ¬¡ç®¡ç†èˆ‡æ‹–æ›³ ---
        function renderShiftList() {
            const list = document.getElementById('shift-list');
            list.innerHTML = '';
            shifts.forEach((shift, index) => {
                const item = document.createElement('div');
                item.className = 'shift-item';
                item.draggable = true;
                item.innerHTML = `
                    <div class="drag-handle">â˜°</div>
                    <input type="text" value="${shift.name}" onchange="updateShift(${index}, 'name', this.value)">
                    <input type="time" value="${shift.startTime}" onchange="updateShift(${index}, 'startTime', this.value)">
                    <input type="time" value="${shift.endTime}" onchange="updateShift(${index}, 'endTime', this.value)">
                    <div>å¹³æ—¥éœ€: <input type="number" style="width:50px" value="${shift.normalNeed}" onchange="updateShift(${index}, 'normalNeed', this.value)"></div>
                    <div>æ—ºæ—¥éœ€: <input type="number" style="width:50px" value="${shift.peakNeed}" onchange="updateShift(${index}, 'peakNeed', this.value)"></div>
                    <button class="delete-btn" onclick="deleteShift(${index})">åˆªé™¤</button>
                `;
                
                item.addEventListener('dragstart', () => item.classList.add('dragging'));
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    saveShifts();
                });
                list.appendChild(item);
            });

            list.addEventListener('dragover', e => {
                e.preventDefault();
                const draggingItem = document.querySelector('.dragging');
                const siblings = [...list.querySelectorAll('.shift-item:not(.dragging)')];
                const nextSibling = siblings.find(sibling => e.clientY <= sibling.offsetTop + sibling.offsetHeight / 2);
                list.insertBefore(draggingItem, nextSibling);
                
                // æ›´æ–°é™£åˆ—é †åº
                const newShifts = [];
                list.querySelectorAll('.shift-item').forEach(el => {
                    const name = el.querySelector('input[type="text"]').value;
                    newShifts.push(shifts.find(s => s.name === name));
                });
                shifts = newShifts;
            });
        }

        function addShift() {
            shifts.push({ id: Date.now(), name: 'æ–°ç­æ¬¡', startTime: '09:00', endTime: '17:00', normalNeed: 1, peakNeed: 2 });
            renderShiftList();
            renderScheduleTable();
        }

        function updateShift(index, field, value) {
            shifts[index][field] = value;
            saveShifts();
            renderScheduleTable();
        }

        function deleteShift(index) {
            shifts.splice(index, 1);
            renderShiftList();
            renderScheduleTable();
        }

        function saveShifts() {
            localStorage.setItem('shifts', JSON.stringify(shifts));
        }

        // --- å“¡å·¥ç®¡ç† ---
        function renderEmployeeList() {
            const list = document.getElementById('employee-list');
            document.getElementById('emp-count').innerText = employees.length;
            list.innerHTML = '';
            employees.forEach((emp, index) => {
                const card = document.createElement('div');
                card.className = `employee-card ${emp.type}`;
                card.innerHTML = `
                    <div class="header">
                        <div class="name">${emp.name}</div>
                        <div class="type-badge ${emp.type}">${emp.type === 'fulltime' ? 'æ­£è·' : 'å…¼è·'}</div>
                    </div>
                    <div class="info">æ¯é€±æœ€å¤š ${emp.maxDays} å¤© / ${emp.maxHours} å°æ™‚</div>
                    <div class="actions">
                        <button onclick="deleteEmployee(${index})">ğŸ—‘ï¸</button>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function addEmployee() {
            const name = document.getElementById('emp-name').value;
            if (!name) return alert('è«‹è¼¸å…¥å§“å');
            const type = document.getElementById('emp-type').value;
            const maxDays = parseInt(document.getElementById('emp-max-days').value);
            const maxHours = parseInt(document.getElementById('emp-max-hours').value);
            const availability = Array.from(document.querySelectorAll('.emp-avail:checked')).map(cb => parseInt(cb.value));

            employees.push({ id: Date.now(), name, type, maxDays, maxHours, availability, preferences: [] });
            localStorage.setItem('employees', JSON.stringify(employees));
            renderEmployeeList();
            document.getElementById('emp-name').value = '';
        }

        function deleteEmployee(index) {
            if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) {
                employees.splice(index, 1);
                localStorage.setItem('employees', JSON.stringify(employees));
                renderEmployeeList();
            }
        }

        // --- AI æ’ç­æ¼”ç®—æ³• ---
        function runAIScheduling() {
            const start = new Date(currentWeekStart);
            const newSchedules = { ...schedules };
            
            // æ¸…ç©ºæœ¬é€±
            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                shifts.forEach(s => delete newSchedules[`${dateStr}_${s.id}`]);
            }

            // ç°¡å–®çš„æ¬Šé‡æ’ç­
            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const day = d.getDay();
                const isPeak = isPeakDay(d);

                shifts.forEach(shift => {
                    const need = isPeak ? shift.peakNeed : shift.normalNeed;
                    const key = `${dateStr}_${shift.id}`;
                    newSchedules[key] = [];

                    // ç¯©é¸å¯ç”¨å“¡å·¥ä¸¦è©•åˆ†
                    let candidates = employees.filter(emp => emp.availability.includes(day))
                        .map(emp => {
                            let score = emp.type === 'fulltime' ? 100 : 50;
                            // éš¨æ©Ÿæ€§
                            score += Math.random() * 20;
                            return { emp, score };
                        })
                        .sort((a, b) => b.score - a.score);

                    for (let j = 0; j < Math.min(need, candidates.length); j++) {
                        newSchedules[key].push(candidates[j].emp.id);
                    }
                });
            }

            schedules = newSchedules;
            renderScheduleTable();
            alert('AI æ’ç­å®Œæˆï¼');
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
