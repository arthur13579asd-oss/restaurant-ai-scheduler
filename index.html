<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å»³ AI æ’ç­ç³»çµ± - å®œè˜­ç¾…æ±åº—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* é ‚éƒ¨å°èˆª */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .navbar h1 {
            font-size: 20px;
        }

        .navbar .store-name {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 13px;
        }

        /* Tab å°èˆª */
        .tabs {
            background: white;
            display: flex;
            border-bottom: 2px solid #e8ebf2;
            padding: 0 15px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
            font-size: 14px;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* ä¸»å…§å®¹å€ */
        .main-content {
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .card h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* æ’ç­è¡¨æ¨£å¼å„ªåŒ– - æ¢å¾©å¤§å°ºå¯¸ç‰ˆ */
        .month-label {
            font-size: 2rem;
            font-weight: 800;
            color: #2b6cb0;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            table-layout: fixed;
        }

        .schedule-table th, .schedule-table td {
            border: 1px solid #e2e8f0;
            padding: 20px 12px;
            text-align: center;
            vertical-align: top;
            min-height: 140px;
        }

        .schedule-table th {
            background: #f8f9fc;
            font-weight: 700;
            color: #4a5568;
            font-size: 1.1rem;
        }

        .schedule-table td.peak-day {
            background-color: #fffaf0;
        }

        .schedule-table td.holiday-day {
            background-color: #fff5f5;
        }

        .shift-label {
            font-weight: 700;
            color: #2d3748;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .shift-time {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 10px;
        }

        .employee-tag {
            display: inline-flex;
            align-items: center;
            background: #edf2f7;
            padding: 6px 12px;
            border-radius: 6px;
            margin: 4px;
            font-size: 15px;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: relative;
        }

        .employee-tag.fulltime {
            border-left: 3px solid #48bb78;
        }

        .employee-tag.parttime {
            border-left: 3px solid #ecc94b;
        }

        .remove-btn {
            margin-left: 5px;
            cursor: pointer;
            color: #a0aec0;
            font-weight: bold;
        }

        .remove-btn:hover {
            color: #e53e3e;
        }

        .quick-add-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: #4299e1;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            margin: 12px auto;
            display: block;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.3);
        }

        .quick-add-btn:hover {
            background: #3182ce;
            transform: scale(1.1);
        }

        .need-more {
            color: #e53e3e;
            font-size: 0.85rem;
            margin-top: 6px;
            font-weight: 600;
        }

        /* å¤©æ°£æ¨£å¼ */
        .schedule-weather {
            font-size: 11px;
            margin: 6px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            background: rgba(255, 255, 255, 0.7);
            padding: 6px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .weather-main {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 700;
            font-size: 1rem;
        }

        .weather-detail {
            display: flex;
            gap: 6px;
            font-size: 10px;
            color: #4a5568;
        }

        .high-pop {
            color: #e53e3e !important;
            font-weight: 800;
        }

        /* å¿«é€Ÿæ–°å¢é¸å–® */
        .quick-add-menu {
            position: fixed;
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            padding: 10px;
            min-width: 160px;
            display: none;
            border: 1px solid #e2e8f0;
        }

        .quick-add-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
            font-weight: 500;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quick-add-item:hover {
            background: #f7fafc;
            color: #3182ce;
        }

        /* æ¯æ—¥ç¸½å·¥æ™‚çµ±è¨ˆ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
        }

        .stat-card {
            background: #f8f9fc;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-card.peak { background-color: #fffaf0; border-color: #fbd38d; }
        .stat-card.holiday { background-color: #fff5f5; border-color: #feb2b2; }

        .stat-value {
            font-size: 20px;
            font-weight: 800;
            color: #2d3748;
            margin: 4px 0;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            font-weight: 600;
        }

        /* æ—¥æ›†è¦–åœ–ä¿®å¾© */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .calendar-nav button {
            background: #f0f2f5;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
        }

        .calendar-grid .day-header {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
        }

        .calendar-grid .day-cell {
            background: white;
            min-height: 100px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .calendar-grid .day-cell:hover {
            background: #f8f9fc;
        }

        .calendar-grid .day-cell.other-month {
            background: #f5f5f5;
            color: #aaa;
        }

        .calendar-grid .day-cell.today {
            background: #e3f2fd;
        }

        .calendar-grid .day-cell.peak {
            background: #fff3e0;
        }

        .calendar-grid .day-cell.holiday {
            background: #fce4ec;
        }

        .calendar-grid .day-cell .date {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .calendar-grid .day-cell .holiday-name {
            font-size: 10px;
            color: #e53e3e;
            background: #fff5f5;
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 800;
        }

        .calendar-grid .day-cell .peak-tag {
            display: inline-block;
            font-size: 10px;
            background: #f6ad55;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            margin-top: 4px;
            font-weight: 800;
        }

        /* å“¡å·¥ç®¡ç†å„ªåŒ– */
        .employee-table-container {
            width: 100%;
            overflow-x: auto;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .employee-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        .employee-table th, .employee-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }

        .employee-table th {
            background: #f8f9fc;
            font-weight: 700;
            color: #4a5568;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .employee-table tr:hover {
            background-color: #f7fafc;
        }

        .employee-table tr:last-child td {
            border-bottom: none;
        }

        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .type-fulltime { background: #d4edda; color: #155724; }
        .type-parttime { background: #fff3cd; color: #856404; }

        .avail-dot {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            border-radius: 50%;
            margin-right: 2px;
            font-size: 11px;
            background: #edf2f7;
            color: #a0aec0;
        }

        .avail-dot.active {
            background: #667eea;
            color: white;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 13px;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-danger { background: #e53e3e; color: white; }
        .btn-success { background: #48bb78; color: white; }
        
        .ai-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 20px;
            color: white;
            margin-bottom: 15px;
        }
        .ai-section h2 { color: white; font-size: 18px; margin-bottom: 10px; }
        .ai-section p { font-size: 14px; margin-bottom: 15px; opacity: 0.9; }
        .btn-ai {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
        }

        /* ç­æ¬¡è¨­å®šåˆ—è¡¨ */
        .shift-item {
            display: grid;
            grid-template-columns: 30px 2fr 1.5fr 1.5fr 1fr 1fr 80px;
            gap: 10px;
            align-items: center;
            padding: 12px;
            background: white;
            border-bottom: 1px solid #edf2f7;
        }
        .drag-handle { cursor: grab; font-size: 18px; color: #cbd5e0; }
        .shift-item input { padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }

        /* è¦–åœ–åˆ‡æ›æŒ‰éˆ•æ¨£å¼ */
        .view-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .view-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: white;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.2s;
        }
        .view-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>é¤å»³ AI æ’ç­ç³»çµ±</h1>
        <div class="store-name">å®œè˜­ç¾…æ±åº—</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('schedule')">æ’ç­è¡¨</div>
        <div class="tab" onclick="switchTab('employees')">å“¡å·¥ç®¡ç†</div>
        <div class="tab" onclick="switchTab('shifts')">ç­æ¬¡è¨­å®š</div>
        <div class="tab" onclick="switchTab('holidays')">å‡æ—¥æ—¥æ›†</div>
        <div class="tab" onclick="switchTab('peak-settings')">æ—ºæ—¥è¨­å®š</div>
    </div>

    <div class="main-content">
        <!-- æ’ç­è¡¨åˆ†é  -->
        <div id="schedule" class="tab-content active">
            <div class="ai-section">
                <h2>AI æ™ºèƒ½æ’ç­</h2>
                <p>æ ¹æ“šå“¡å·¥å¯ç”¨æ™‚æ®µã€æ—ºæ—¥/å¹³æ—¥éœ€æ±‚ã€ä»¥åŠå°ç£åœ‹å®šå‡æ—¥è‡ªå‹•ç”Ÿæˆæœ€ä½³æ’ç­</p>
                <button class="btn-ai" onclick="runAIScheduling()">é–‹å§‹ AI æ’ç­</button>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2>æœ¬é€±æ’ç­è¡¨</h2>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button class="btn" style="background:#edf2f7" onclick="changeWeek(-1)">&lt; ä¸Šé€±</button>
                        <span id="current-week-label" style="font-weight: 700; font-size: 1rem;"></span>
                        <button class="btn" style="background:#edf2f7" onclick="changeWeek(1)">ä¸‹é€± &gt;</button>
                    </div>
                </div>

                <div class="view-switcher">
                    <button id="view-shift" class="view-btn active" onclick="switchView('shift')">ç­æ¬¡å°å‘ (æ™‚é–“åœ¨å·¦)</button>
                    <button id="view-person" class="view-btn" onclick="switchView('person')">äººå“¡å°å‘ (å§“ååœ¨å·¦)</button>
                </div>
                
                <div id="schedule-container">
                    <!-- è¡¨æ ¼å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>

                <div style="margin-top: 20px; display: flex; gap: 12px;">
                    <button class="btn btn-success" onclick="saveSchedule()">å„²å­˜æ’ç­</button>
                    <button class="btn" style="background:#edf2f7" onclick="exportCSV()">åŒ¯å‡º CSV</button>
                    <button class="btn btn-danger" onclick="clearWeekSchedule()">æ¸…ç©ºæœ¬é€±</button>
                </div>
            </div>

            <div class="card">
                <h2>æ¯æ—¥ç¸½å·¥æ™‚çµ±è¨ˆ</h2>
                <div id="daily-stats" class="stats-grid">
                    <!-- çµ±è¨ˆå°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- å“¡å·¥ç®¡ç†åˆ†é  -->
        <div id="employees" class="tab-content">
            <div class="card">
                <h2>æ–°å¢å“¡å·¥</h2>
                <div class="form-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 12px;">
                    <div class="form-group" style="display: flex; flex-direction: column;">
                        <label style="font-size: 12px; margin-bottom: 4px;">å§“å</label>
                        <input type="text" id="emp-name" placeholder="è¼¸å…¥å§“å" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div class="form-group" style="display: flex; flex-direction: column;">
                        <label style="font-size: 12px; margin-bottom: 4px;">é¡å‹</label>
                        <select id="emp-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="fulltime">æ­£è·</option>
                            <option value="parttime">å…¼è·</option>
                        </select>
                    </div>
                    <div class="form-group" style="display: flex; flex-direction: column;">
                        <label style="font-size: 12px; margin-bottom: 4px;">æ¯é€±æœ€å¤šå·¥ä½œå¤©æ•¸</label>
                        <input type="number" id="emp-max-days" value="5" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div class="form-group" style="display: flex; flex-direction: column;">
                        <label style="font-size: 12px; margin-bottom: 4px;">æ¯é€±æœ€å¤šå·¥ä½œå°æ™‚</label>
                        <input type="number" id="emp-max-hours" value="40" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; font-weight: 500; color: #555;">å¯ç”¨æ™‚æ®µ</label>
                    <div style="display: flex; gap: 8px; margin-top: 4px; font-size: 13px;">
                        <label><input type="checkbox" class="emp-avail" value="1" checked> é€±ä¸€</label>
                        <label><input type="checkbox" class="emp-avail" value="2" checked> é€±äºŒ</label>
                        <label><input type="checkbox" class="emp-avail" value="3" checked> é€±ä¸‰</label>
                        <label><input type="checkbox" class="emp-avail" value="4" checked> é€±å››</label>
                        <label><input type="checkbox" class="emp-avail" value="5" checked> é€±äº”</label>
                        <label><input type="checkbox" class="emp-avail" value="6" checked> é€±å…­</label>
                        <label><input type="checkbox" class="emp-avail" value="0" checked> é€±æ—¥</label>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addEmployee()">æ–°å¢å“¡å·¥</button>
            </div>

            <div class="card">
                <h2>å“¡å·¥åˆ—è¡¨ <span id="emp-count" style="background:#667eea; color:white; font-size:11px; padding:2px 8px; border-radius:10px; margin-left:8px;">0</span></h2>
                <div id="employee-list"></div>
            </div>
        </div>

        <!-- ç­æ¬¡è¨­å®šåˆ†é  -->
        <div id="shifts" class="tab-content">
            <div class="card">
                <h2>ç­æ¬¡è¨­å®š (å¯æ‹–æ›³æ’åº)</h2>
                <div id="shift-list" class="shift-list">
                    <!-- ç­æ¬¡å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
                <button class="btn btn-primary" style="margin-top: 15px;" onclick="addShift()">æ–°å¢ç­æ¬¡</button>
            </div>
        </div>

        <!-- å‡æ—¥æ—¥æ›†åˆ†é  -->
        <div id="holidays" class="tab-content">
            <div class="card">
                <div class="calendar-header">
                    <h2>å‡æ—¥æ—¥æ›†</h2>
                    <div class="calendar-nav">
                        <button onclick="changeCalendarMonth(-1)">&lt;</button>
                        <div id="calendar-month-label" style="font-weight: 600; font-size: 1.1rem; min-width: 120px; text-align: center;">2025å¹´ 1æœˆ</div>
                        <button onclick="changeCalendarMonth(1)">&gt;</button>
                    </div>
                </div>
                <div id="calendar-grid" class="calendar-grid">
                    <div class="day-header">æ—¥</div>
                    <div class="day-header">ä¸€</div>
                    <div class="day-header">äºŒ</div>
                    <div class="day-header">ä¸‰</div>
                    <div class="day-header">å››</div>
                    <div class="day-header">äº”</div>
                    <div class="day-header">å…­</div>
                    <!-- æ—¥æœŸå°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- æ—ºæ—¥è¨­å®šåˆ†é  -->
        <div id="peak-settings" class="tab-content">
            <div class="card">
                <h2>æ—ºæ—¥åˆ¤å®šè¨­å®š</h2>
                <div style="display: flex; flex-direction: column; gap: 12px; font-size: 14px;">
                    <label><input type="checkbox" id="peak-weekend" checked> é€±å…­ã€é€±æ—¥è¦–ç‚ºæ—ºæ—¥</label>
                    <label><input type="checkbox" id="peak-holiday" checked> åœ‹å®šå‡æ—¥è¦–ç‚ºæ—ºæ—¥</label>
                    <label><input type="checkbox" id="peak-vacation" checked> å¤§å­¸å¯’æš‘å‡æœŸé–“è¦–ç‚ºæ—ºæ—¥</label>
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿæ–°å¢å“¡å·¥é¸å–® -->
    <div id="quick-add-menu" class="quick-add-menu"></div>

    <script>
        // --- è³‡æ–™åˆå§‹åŒ– ---
        let employees = JSON.parse(localStorage.getItem('employees')) || [
            { id: 1, name: 'ç‹å¤§æ˜', type: 'fulltime', maxDays: 5, maxHours: 40, availability: [1,2,3,4,5,6,0], preferences: [] },
            { id: 2, name: 'æå°è¯', type: 'fulltime', maxDays: 5, maxHours: 40, availability: [1,2,3,4,5,6,0], preferences: [] },
            { id: 3, name: 'å¼µä¸‰', type: 'parttime', maxDays: 3, maxHours: 24, availability: [5,6,0], preferences: [] },
            { id: 4, name: 'é™³å››', type: 'parttime', maxDays: 4, maxHours: 32, availability: [1,2,3,6,0], preferences: [] },
            { id: 5, name: 'æ—äº”', type: 'fulltime', maxDays: 5, maxHours: 40, availability: [1,2,3,4,5], preferences: [] }
        ];

        let shifts = JSON.parse(localStorage.getItem('shifts')) || [
            { id: 1, name: 'é–‹æ—©', startTime: '10:00', endTime: '15:00', normalNeed: 1, peakNeed: 2 },
            { id: 2, name: 'ä¸‹åˆ', startTime: '15:00', endTime: '18:00', normalNeed: 2, peakNeed: 3 },
            { id: 3, name: 'æ™šç­', startTime: '18:00', endTime: '22:00', normalNeed: 5, peakNeed: 7 },
            { id: 4, name: 'æ”¶å°¾', startTime: '22:00', endTime: '01:00', normalNeed: 3, peakNeed: 4 }
        ];

        let schedules = JSON.parse(localStorage.getItem('schedules')) || {};
        let weatherData = {};
        let currentView = 'shift'; // 'shift' or 'person'

        const holidays2025 = {
            '2025-01-01': 'å…ƒæ—¦', 
            '2025-01-25': 'æ˜¥ç¯€å‡æœŸ', '2025-01-26': 'æ˜¥ç¯€å‡æœŸ', '2025-01-27': 'é™¤å¤•å‰ä¸€æ—¥', '2025-01-28': 'é™¤å¤•', 
            '2025-01-29': 'åˆä¸€', '2025-01-30': 'åˆäºŒ', '2025-01-31': 'åˆä¸‰', '2025-02-01': 'åˆå››', '2025-02-02': 'åˆäº”',
            '2025-02-28': 'å’Œå¹³ç´€å¿µæ—¥', '2025-04-03': 'å…’ç«¥ç¯€', '2025-04-04': 'æ¸…æ˜ç¯€', '2025-05-01': 'å‹å‹•ç¯€',
            '2025-05-31': 'ç«¯åˆç¯€', '2025-10-06': 'ä¸­ç§‹ç¯€', '2025-10-10': 'åœ‹æ…¶æ—¥',
            '2026-01-01': 'å…ƒæ—¦',
            '2026-02-16': 'é™¤å¤•', '2026-02-17': 'åˆä¸€', '2026-02-18': 'åˆäºŒ', '2026-02-19': 'åˆä¸‰', '2026-02-20': 'åˆå››', '2026-02-21': 'åˆäº”',
            '2026-02-28': 'å’Œå¹³ç´€å¿µæ—¥', '2026-04-04': 'å…’ç«¥ç¯€', '2026-04-05': 'æ¸…æ˜ç¯€', '2026-05-01': 'å‹å‹•ç¯€',
            '2026-06-19': 'ç«¯åˆç¯€', '2026-09-25': 'ä¸­ç§‹ç¯€', '2026-10-10': 'åœ‹æ…¶æ—¥'
        };

        let currentWeekStart = getMonday(new Date());
        let calendarDate = new Date();

        function getMonday(d) {
            d = new Date(d);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        async function fetchWeather() {
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=24.67&longitude=121.76&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTaipei&past_days=7');
                const data = await res.json();
                data.daily.time.forEach((time, i) => {
                    weatherData[time] = {
                        code: data.daily.weathercode[i],
                        max: data.daily.temperature_2m_max[i],
                        min: data.daily.temperature_2m_min[i],
                        pop: data.daily.precipitation_probability_max[i]
                    };
                });
                renderScheduleTable();
            } catch (e) { console.error('Weather fetch failed', e); }
        }

        function getWeatherIcon(code) {
            if (code === 0) return 'â˜€ï¸';
            if (code <= 3) return 'â›…';
            if (code <= 48) return 'ğŸŒ«ï¸';
            if (code <= 67) return 'ğŸŒ§ï¸';
            if (code <= 77) return 'â„ï¸';
            if (code <= 82) return 'ğŸŒ¦ï¸';
            if (code <= 99) return 'â›ˆï¸';
            return 'â“';
        }

        function isPeakDay(date) {
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const day = date.getDay();
            if (document.getElementById('peak-weekend').checked && (day === 0 || day === 6)) return true;
            if (document.getElementById('peak-holiday').checked && holidays2025[dateStr]) return true;
            if (document.getElementById('peak-vacation').checked) {
                const m = date.getMonth() + 1; const d = date.getDate();
                if ((m === 1 && d >= 21) || m === 2 || (m === 7) || m === 8) return true;
            }
            return false;
        }

        function switchView(view) {
            currentView = view;
            document.getElementById('view-shift').classList.toggle('active', view === 'shift');
            document.getElementById('view-person').classList.toggle('active', view === 'person');
            renderScheduleTable();
        }

        function renderScheduleTable() {
            const container = document.getElementById('schedule-container');
            const start = new Date(currentWeekStart);
            const end = new Date(start); end.setDate(end.getDate() + 6);
            document.getElementById('current-week-label').innerText = `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;

            if (currentView === 'shift') {
                renderShiftView(container, start);
            } else {
                renderPersonView(container, start);
            }
            updateStats();
        }

        function renderShiftView(container, start) {
            let html = `<div class="month-label">${start.getMonth() + 1}æœˆ</div><table class="schedule-table"><thead><tr><th style="width:150px">ç­æ¬¡</th>`;
            const days = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'];
            for (let i = 0; i < 7; i++) {
                const d = new Date(start); d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const weather = weatherData[dateStr];
                const isPeak = isPeakDay(d);
                const holiday = holidays2025[dateStr];
                html += `<th class="${isPeak ? 'peak-day' : ''} ${holiday ? 'holiday-day' : ''}">
                    <div style="font-size:0.9rem; color:#718096">${days[i]}</div>
                    <div style="font-size:1.1rem; margin:4px 0">${d.getMonth() + 1}/${d.getDate()}</div>
                    ${weather ? `<div class="schedule-weather">
                        <div class="weather-main">${getWeatherIcon(weather.code)} ${Math.round(weather.max)}Â°</div>
                        <div class="weather-detail"><span>${Math.round(weather.min)}Â°</span> <span class="${weather.pop > 40 ? 'high-pop' : ''}">â˜”${weather.pop}%</span></div>
                    </div>` : ''}
                    ${holiday ? `<div style="font-size:10px; color:#e53e3e; font-weight:800">${holiday}</div>` : ''}
                    ${isPeak && !holiday ? `<div style="font-size:10px; color:#f6ad55; font-weight:800">æ—ºæ—¥</div>` : ''}
                </th>`;
            }
            html += `</tr></thead><tbody>`;

            shifts.forEach(shift => {
                html += `<tr><td><div class="shift-label">${shift.name}</div><div class="shift-time">${shift.startTime} - ${shift.endTime}</div></td>`;
                for (let i = 0; i < 7; i++) {
                    const d = new Date(start); d.setDate(d.getDate() + i);
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    const isPeak = isPeakDay(d);
                    const need = isPeak ? shift.peakNeed : shift.normalNeed;
                    const key = `${dateStr}_${shift.id}`;
                    const assigned = schedules[key] || [];
                    html += `<td class="${isPeak ? 'peak-day' : ''}"><div id="cell-${key}" class="cell-content">`;
                    assigned.forEach(empId => {
                        const emp = employees.find(e => e.id == empId);
                        if (emp) html += `<span class="employee-tag ${emp.type}">${emp.name}<span class="remove-btn" onclick="removeFromShift('${key}', ${emp.id})">Ã—</span></span>`;
                    });
                    html += `</div>`;
                    if (assigned.length < need) html += `<div class="need-more">é‚„éœ€ ${need - assigned.length} äºº</div>`;
                    html += `<div class="quick-add-btn" onclick="showQuickAdd(event, '${key}')">+</div></td>`;
                }
                html += `</tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function renderPersonView(container, start) {
            let html = `<div class="month-label">${start.getMonth() + 1}æœˆ</div><table class="schedule-table"><thead><tr><th style="width:150px">å“¡å·¥å§“å</th>`;
            const days = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'];
            for (let i = 0; i < 7; i++) {
                const d = new Date(start); d.setDate(d.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const weather = weatherData[dateStr];
                const isPeak = isPeakDay(d);
                const holiday = holidays2025[dateStr];
                html += `<th class="${isPeak ? 'peak-day' : ''} ${holiday ? 'holiday-day' : ''}">
                    <div style="font-size:0.9rem; color:#718096">${days[i]}</div>
                    <div style="font-size:1.1rem; margin:4px 0">${d.getMonth() + 1}/${d.getDate()}</div>
                    ${weather ? `<div class="schedule-weather">
                        <div class="weather-main">${getWeatherIcon(weather.code)} ${Math.round(weather.max)}Â°</div>
                        <div class="weather-detail"><span>${Math.round(weather.min)}Â°</span> <span class="${weather.pop > 40 ? 'high-pop' : ''}">â˜”${weather.pop}%</span></div>
                    </div>` : ''}
                </th>`;
            }
            html += `</tr></thead><tbody>`;

            employees.forEach(emp => {
                html += `<tr><td style="vertical-align:middle"><div class="shift-label">${emp.name}</div><div class="type-badge ${emp.type === 'fulltime' ? 'type-fulltime' : 'type-parttime'}">${emp.type === 'fulltime' ? 'æ­£è·' : 'å…¼è·'}</div></td>`;
                for (let i = 0; i < 7; i++) {
                    const d = new Date(start); d.setDate(d.getDate() + i);
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    const isPeak = isPeakDay(d);
                    html += `<td class="${isPeak ? 'peak-day' : ''}"><div class="cell-content">`;
                    
                    // æ‰¾å‡ºè©²å“¡å·¥ç•¶å¤©æ‰€æœ‰çš„ç­æ¬¡
                    shifts.forEach(shift => {
                        const key = `${dateStr}_${shift.id}`;
                        const assigned = schedules[key] || [];
                        if (assigned.includes(emp.id)) {
                            html += `<div style="background:#667eea; color:white; padding:4px 8px; border-radius:4px; margin-bottom:4px; font-size:12px; font-weight:bold;">
                                ${shift.name}<br>${shift.startTime}-${shift.endTime}
                                <span class="remove-btn" style="color:white; float:right" onclick="removeFromShift('${key}', ${emp.id})">Ã—</span>
                            </div>`;
                        }
                    });
                    
                    html += `</div></td>`;
                }
                html += `</tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function showQuickAdd(event, key) {
            event.stopPropagation();
            const menu = document.getElementById('quick-add-menu');
            const assigned = schedules[key] || [];
            let html = `<div style="font-weight:bold; margin-bottom:6px; padding:0 5px; color:#4a5568; font-size:12px">å¿«é€Ÿæ–°å¢äººå“¡</div>`;
            employees.forEach(emp => {
                if (!assigned.includes(emp.id)) {
                    html += `<div class="quick-add-item" onclick="addToShift('${key}', ${emp.id})"><span>${emp.name}</span><span style="font-size:9px; color:#aaa">${emp.type === 'fulltime' ? 'æ­£è·' : 'å…¼è·'}</span></div>`;
                }
            });
            menu.innerHTML = html; menu.style.display = 'block';
            menu.style.left = event.pageX + 'px'; menu.style.top = event.pageY + 'px';
        }

        function addToShift(key, empId) {
            if (!schedules[key]) schedules[key] = [];
            if (!schedules[key].includes(empId)) { schedules[key].push(empId); renderScheduleTable(); }
            document.getElementById('quick-add-menu').style.display = 'none';
        }

        function removeFromShift(key, empId) {
            if (schedules[key]) { schedules[key] = schedules[key].filter(id => id != empId); renderScheduleTable(); }
        }

        function updateStats() {
            const statsContainer = document.getElementById('daily-stats');
            const start = new Date(currentWeekStart);
            const days = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'];
            let html = '';
            for (let i = 0; i < 7; i++) {
                const d = new Date(start); d.setDate(d.getDate() + i);
                const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                const isPeak = isPeakDay(d);
                const holiday = holidays2025[dateStr];
                let dailyHours = 0;
                shifts.forEach(shift => {
                    const key = `${dateStr}_${shift.id}`;
                    const assigned = schedules[key] || [];
                    let startH = parseInt(shift.startTime.split(':')[0]);
                    let endH = parseInt(shift.endTime.split(':')[0]);
                    if (endH < startH) endH += 24;
                    dailyHours += assigned.length * (endH - startH);
                });
                html += `<div class="stat-card ${isPeak ? 'peak' : ''} ${holiday ? 'holiday' : ''}">
                    <div class="stat-label">${days[i]} (${(d.getMonth()+1)}/${d.getDate()})</div>
                    <div class="stat-value">${dailyHours.toFixed(1)}h</div>
                    <div class="stat-label">ç•¶æ—¥ç¸½å·¥æ™‚</div>
                </div>`;
            }
            statsContainer.innerHTML = html;
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            if (tabId === 'holidays') renderCalendar();
            if (tabId === 'employees') renderEmployeeList();
            if (tabId === 'shifts') renderShiftList();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthLabel = document.getElementById('calendar-month-label');
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            monthLabel.innerText = `${year}å¹´ ${month + 1}æœˆ`;

            const headers = Array.from(grid.querySelectorAll('.day-header'));
            grid.innerHTML = '';
            headers.forEach(h => grid.appendChild(h));

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDays = new Date(year, month, 0).getDate();

            for (let i = firstDay - 1; i >= 0; i--) {
                const cell = document.createElement('div');
                cell.className = 'day-cell other-month';
                cell.innerText = prevMonthDays - i;
                grid.appendChild(cell);
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const d = new Date(year, month, i);
                const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                if (isPeakDay(d)) cell.classList.add('peak');
                if (holidays2025[dateStr]) cell.classList.add('holiday');
                
                const holidayName = holidays2025[dateStr] || '';
                const isPeak = isPeakDay(d);
                let content = `<div class="date"><span>${i}</span>`;
                if (holidayName) content += `<span class="holiday-name">${holidayName}</span>`;
                content += `</div>`;
                if (isPeak) content += `<div class="peak-tag">æ—º</div>`;
                cell.innerHTML = content;
                grid.appendChild(cell);
            }
        }

        function changeCalendarMonth(offset) {
            calendarDate.setMonth(calendarDate.getMonth() + offset);
            renderCalendar();
        }

        function changeWeek(offset) { currentWeekStart.setDate(currentWeekStart.getDate() + (offset * 7)); renderScheduleTable(); }
        function saveSchedule() { localStorage.setItem('schedules', JSON.stringify(schedules)); alert('æ’ç­å·²å„²å­˜ï¼'); }
        function clearWeekSchedule() { 
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæœ¬é€±æ‰€æœ‰æ’ç­å—ï¼Ÿ')) { 
                const start = new Date(currentWeekStart); 
                for (let i = 0; i < 7; i++) { 
                    const d = new Date(start); 
                    d.setDate(d.getDate() + i); 
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    shifts.forEach(s => delete schedules[`${dateStr}_${s.id}`]); 
                } 
                renderScheduleTable(); 
            } 
        }

        function renderShiftList() {
            const list = document.getElementById('shift-list'); list.innerHTML = '';
            shifts.forEach((shift, index) => {
                const item = document.createElement('div'); item.className = 'shift-item'; item.draggable = true;
                item.innerHTML = `<div class="drag-handle">â˜°</div><input type="text" value="${shift.name}" onchange="updateShift(${index}, 'name', this.value)"><input type="time" value="${shift.startTime}" onchange="updateShift(${index}, 'startTime', this.value)"><input type="time" value="${shift.endTime}" onchange="updateShift(${index}, 'endTime', this.value)"><div>å¹³æ—¥: <input type="number" style="width:40px" value="${shift.normalNeed}" onchange="updateShift(${index}, 'normalNeed', this.value)"></div><div>æ—ºæ—¥: <input type="number" style="width:40px" value="${shift.peakNeed}" onchange="updateShift(${index}, 'peakNeed', this.value)"></div><button class="delete-btn" style="background:#ffebee; color:#c62828; border:none; padding:5px 10px; border-radius:4px; cursor:pointer" onclick="deleteShift(${index})">åˆªé™¤</button>`;
                item.addEventListener('dragstart', () => item.classList.add('dragging'));
                item.addEventListener('dragend', () => { item.classList.remove('dragging'); saveShifts(); });
                list.appendChild(item);
            });
            list.addEventListener('dragover', e => {
                e.preventDefault(); const draggingItem = document.querySelector('.dragging'); const siblings = [...list.querySelectorAll('.shift-item:not(.dragging)')];
                const nextSibling = siblings.find(sibling => e.clientY <= sibling.offsetTop + sibling.offsetHeight / 2);
                list.insertBefore(draggingItem, nextSibling);
                const newShifts = []; list.querySelectorAll('.shift-item').forEach(el => { const name = el.querySelector('input[type="text"]').value; newShifts.push(shifts.find(s => s.name === name)); });
                shifts = newShifts;
            });
        }

        function addShift() { shifts.push({ id: Date.now(), name: 'æ–°ç­æ¬¡', startTime: '09:00', endTime: '17:00', normalNeed: 1, peakNeed: 2 }); renderShiftList(); renderScheduleTable(); }
        function updateShift(index, field, value) { shifts[index][field] = value; saveShifts(); renderScheduleTable(); }
        function deleteShift(index) { shifts.splice(index, 1); renderShiftList(); renderScheduleTable(); }
        function saveShifts() { localStorage.setItem('shifts', JSON.stringify(shifts)); }

        function renderEmployeeList() {
            const list = document.getElementById('employee-list'); 
            document.getElementById('emp-count').innerText = employees.length; 
            
            if (employees.length === 0) {
                list.innerHTML = '<div style="text-align:center; padding:30px; color:#a0aec0;">å°šç„¡å“¡å·¥è³‡æ–™</div>';
                return;
            }

            let html = `
                <div class="employee-table-container">
                    <table class="employee-table">
                        <thead>
                            <tr>
                                <th>å§“å</th>
                                <th>é¡å‹</th>
                                <th>æ¯é€±ä¸Šé™</th>
                                <th>å¯ç”¨æ™‚æ®µ</th>
                                <th style="text-align:right">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            employees.forEach((emp, index) => {
                const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                let availHtml = '';
                [1, 2, 3, 4, 5, 6, 0].forEach(d => {
                    const isActive = emp.availability.includes(d);
                    availHtml += `<span class="avail-dot ${isActive ? 'active' : ''}">${days[d]}</span>`;
                });

                html += `
                    <tr>
                        <td style="font-weight:700; color:#2d3748">${emp.name}</td>
                        <td><span class="type-badge ${emp.type === 'fulltime' ? 'type-fulltime' : 'type-parttime'}">${emp.type === 'fulltime' ? 'æ­£è·' : 'å…¼è·'}</span></td>
                        <td style="color:#4a5568">${emp.maxDays}å¤© / ${emp.maxHours}å°æ™‚</td>
                        <td>${availHtml}</td>
                        <td style="text-align:right">
                            <button class="btn" style="padding:4px 8px; background:#fff5f5; color:#e53e3e; border:1px solid #feb2b2; font-size:12px" onclick="deleteEmployee(${index})">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            list.innerHTML = html;
        }

        function addEmployee() {
            const name = document.getElementById('emp-name').value;
            const type = document.getElementById('emp-type').value;
            const maxDays = parseInt(document.getElementById('emp-max-days').value);
            const maxHours = parseInt(document.getElementById('emp-max-hours').value);
            const availability = Array.from(document.querySelectorAll('.emp-avail:checked')).map(cb => parseInt(cb.value));
            if (!name) return alert('è«‹è¼¸å…¥å§“å');
            employees.push({ id: Date.now(), name, type, maxDays, maxHours, availability, preferences: [] });
            localStorage.setItem('employees', JSON.stringify(employees));
            document.getElementById('emp-name').value = '';
            renderEmployeeList();
        }

        function deleteEmployee(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å“¡å·¥å—ï¼Ÿ')) {
                employees.splice(index, 1);
                localStorage.setItem('employees', JSON.stringify(employees));
                renderEmployeeList();
                renderScheduleTable();
            }
        }

        function runAIScheduling() {
            if (confirm('AI æ’ç­å°‡è¦†è“‹æœ¬é€±ç¾æœ‰æ’ç­ï¼Œç¢ºå®šç¹¼çºŒï¼Ÿ')) {
                const start = new Date(currentWeekStart);
                for (let i = 0; i < 7; i++) {
                    const d = new Date(start); d.setDate(d.getDate() + i);
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    const isPeak = isPeakDay(d);
                    const dayOfWeek = d.getDay();

                    shifts.forEach(shift => {
                        const key = `${dateStr}_${shift.id}`;
                        schedules[key] = [];
                        const need = isPeak ? shift.peakNeed : shift.normalNeed;
                        
                        let candidates = employees.filter(emp => emp.availability.includes(dayOfWeek));
                        candidates.sort((a, b) => {
                            if (a.type === 'fulltime' && b.type === 'parttime') return -1;
                            if (a.type === 'parttime' && b.type === 'fulltime') return 1;
                            return Math.random() - 0.5;
                        });

                        for (let j = 0; j < Math.min(need, candidates.length); j++) {
                            schedules[key].push(candidates[j].id);
                        }
                    });
                }
                renderScheduleTable();
                alert('AI æ’ç­å®Œæˆï¼');
            }
        }

        function exportCSV() {
            let csv = 'ç­æ¬¡,é€±ä¸€,é€±äºŒ,é€±ä¸‰,é€±å››,é€±äº”,é€±å…­,é€±æ—¥\n';
            const start = new Date(currentWeekStart);
            shifts.forEach(shift => {
                let row = `${shift.name} (${shift.startTime}-${shift.endTime})`;
                for (let i = 0; i < 7; i++) {
                    const d = new Date(start); d.setDate(d.getDate() + i);
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    const key = `${dateStr}_${shift.id}`;
                    const assigned = (schedules[key] || []).map(id => employees.find(e => e.id == id)?.name || '').join('; ');
                    row += `,"${assigned}"`;
                }
                csv += row + '\n';
            });
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `æ’ç­è¡¨_${start.toLocaleDateString()}.csv`;
            link.click();
        }

        // é»æ“Šå¤–éƒ¨é—œé–‰å¿«é€Ÿæ–°å¢é¸å–®
        window.onclick = () => document.getElementById('quick-add-menu').style.display = 'none';

        // åˆå§‹åŒ–
        fetchWeather();
        renderScheduleTable();
        renderEmployeeList();
        renderShiftList();
    </script>
</body>
</html>
