<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å»³ AI æ’ç­ç³»çµ± - å®œè˜­ç¾…æ±åº—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* é ‚éƒ¨å°èˆª */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .navbar h1 {
            font-size: 20px;
        }

        .navbar .store-name {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 13px;
        }

        /* Tab å°èˆª */
        .tabs {
            background: white;
            display: flex;
            border-bottom: 2px solid #e8ebf2;
            padding: 0 15px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
            font-size: 14px;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        /* ä¸»å…§å®¹å€ */
        .main-content {
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .card h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: space-between;
        }

        /* æ’ç­è¡¨æ¨£å¼å„ªåŒ– - æ¢å¾©å¤§å°ºå¯¸ç‰ˆ */
        .month-label {
            font-size: 2rem;
            font-weight: 800;
            color: #2b6cb0;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .view-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .view-btn {
            padding: 8px 16px;
            border: 1px solid #cbd5e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            table-layout: fixed;
        }

        .schedule-table th, .schedule-table td {
            border: 1px solid #e2e8f0;
            padding: 20px 12px;
            text-align: center;
            vertical-align: top;
            min-height: 140px;
        }

        .schedule-table th {
            background: #f8f9fc;
            font-weight: 700;
            color: #4a5568;
            font-size: 1.1rem;
        }

        .schedule-table td.peak-day {
            background-color: #fffaf0;
        }

        .schedule-table td.holiday-day {
            background-color: #fff5f5;
        }

        .shift-label {
            font-weight: 700;
            color: #2d3748;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .shift-time {
            font-size: 0.9rem;
            color: #718096;
            margin-bottom: 10px;
        }

        .employee-tag {
            display: inline-flex;
            align-items: center;
            background: #edf2f7;
            padding: 6px 12px;
            border-radius: 6px;
            margin: 4px;
            font-size: 15px;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: relative;
        }

        .employee-tag.fulltime {
            border-left: 3px solid #48bb78;
        }

        .employee-tag.parttime {
            border-left: 3px solid #ecc94b;
        }

        .remove-btn {
            margin-left: 5px;
            cursor: pointer;
            color: #a0aec0;
            font-weight: bold;
        }

        .remove-btn:hover {
            color: #e53e3e;
        }

        .quick-add-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: #4299e1;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            margin: 12px auto;
            display: block;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(66, 153, 225, 0.3);
        }

        .quick-add-btn:hover {
            background: #3182ce;
            transform: scale(1.1);
        }

        .need-more {
            color: #e53e3e;
            font-size: 0.85rem;
            margin-top: 6px;
            font-weight: 600;
        }

        /* å¤©æ°£æ¨£å¼ */
        .schedule-weather {
            font-size: 11px;
            margin: 6px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            background: rgba(255, 255, 255, 0.7);
            padding: 6px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .weather-main {
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 700;
            font-size: 1rem;
        }

        .weather-detail {
            display: flex;
            gap: 6px;
            font-size: 10px;
            color: #4a5568;
        }

        .high-pop {
            color: #e53e3e !important;
            font-weight: 800;
        }

        /* å¿«é€Ÿæ–°å¢é¸å–® */
        .quick-add-menu {
            position: fixed;
            background: white;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            padding: 10px;
            min-width: 160px;
            display: none;
            border: 1px solid #e2e8f0;
        }

        .quick-add-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
            font-weight: 500;
            font-size: 13px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quick-add-item:hover {
            background: #f7fafc;
            color: #3182ce;
        }

        /* æ¯æ—¥ç¸½å·¥æ™‚çµ±è¨ˆ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 12px;
        }

        .stat-card {
            background: #f8f9fc;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .stat-card.peak { background-color: #fffaf0; border-color: #fbd38d; }
        .stat-card.holiday { background-color: #fff5f5; border-color: #feb2b2; }

        .stat-value {
            font-size: 20px;
            font-weight: 800;
            color: #2d3748;
            margin: 4px 0;
        }

        .stat-label {
            font-size: 12px;
            color: #718096;
            font-weight: 600;
        }

        /* æ—¥æ›†è¦–åœ–ä¿®å¾© */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .calendar-nav button {
            background: #f0f2f5;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
        }

        .calendar-grid .day-header {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
        }

        .calendar-grid .day-cell {
            background: white;
            min-height: 100px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .calendar-grid .day-cell:hover {
            background: #f8f9fc;
        }

        .calendar-grid .day-cell.other-month {
            background: #f5f5f5;
            color: #aaa;
        }

        .calendar-grid .day-cell.today {
            background: #e3f2fd;
        }

        .calendar-grid .day-cell.peak {
            background: #fff3e0;
        }

        .calendar-grid .day-cell.holiday {
            background: #fce4ec;
        }

        .calendar-grid .day-cell .date {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .holiday-tag {
            font-size: 10px;
            color: #e53e3e;
            background: #fff;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 800;
            border: 1px solid #feb2b2;
        }

        .peak-tag {
            font-size: 10px;
            color: #dd6b20;
            background: #fff;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 800;
            border: 1px solid #fbd38d;
            margin-top: 4px;
            display: inline-block;
        }

        /* è¡¨å–®æ¨£å¼ */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd6;
        }

        .btn-danger {
            background: #ff4d4f;
            color: white;
        }

        .btn-outline {
            background: white;
            border: 1px solid #ddd;
            color: #666;
        }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #fff;
        }

        .list-item:hover {
            border-color: #667eea;
        }

        .drag-handle {
            cursor: grab;
            color: #ccc;
            margin-right: 10px;
            font-size: 18px;
            user-select: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .list-item.dragging {
            opacity: 0.5;
            background: #f0f2f5;
            border: 2px dashed #667eea;
        }

        /* æ—ºæ—¥è¨­å®š */
        .peak-settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .peak-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        .peak-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        /* Toast æç¤º */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 2000;
            display: none;
        }

        /* äººå“¡å°å‘è¦–åœ–å°ˆç”¨æ¨£å¼ */
        .person-time-tag {
            display: block;
            background: #ebf8ff;
            color: #2b6cb0;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 4px 0;
            font-size: 13px;
            font-weight: 700;
            border-left: 3px solid #3182ce;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>é¤å»³ AI æ’ç­ç³»çµ±</h1>
        <div class="store-name">å®œè˜­ç¾…æ±åº—</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('schedule')">æ’ç­è¡¨</div>
        <div class="tab" onclick="switchTab('employees')">å“¡å·¥ç®¡ç†</div>
        <div class="tab" onclick="switchTab('shifts')">ç­æ¬¡è¨­å®š</div>
        <div class="tab" onclick="switchTab('calendar')">å‡æ—¥æ—¥æ›†</div>
        <div class="tab" onclick="switchTab('peak')">æ—ºæ—¥è¨­å®š</div>
    </div>

    <div class="main-content">
        <!-- æ’ç­è¡¨åˆ†é  -->
        <div id="schedule" class="tab-content active">
            <div class="card">
                <h2>AI æ™ºèƒ½æ’ç­</h2>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">æ ¹æ“šå“¡å·¥å¯ç”¨æ™‚æ®µã€æ—ºæ—¥/å¹³æ—¥éœ€æ±‚ã€ä»¥åŠå°ç£åœ‹å®šå‡æ—¥è‡ªå‹•ç”Ÿæˆæœ€ä½³æ’ç­</p>
                <button class="btn btn-primary" onclick="runAIScheduling()">é–‹å§‹ AI æ’ç­</button>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2>æœ¬é€±æ’ç­è¡¨</h2>
                    <div class="calendar-nav">
                        <button onclick="changeWeek(-1)">&lt; ä¸Šé€±</button>
                        <span id="weekRangeDisplay" style="font-weight: 600; font-size: 14px;"></span>
                        <button onclick="changeWeek(1)">ä¸‹é€± &gt;</button>
                    </div>
                </div>

                <div class="view-switcher">
                    <button id="view-shift" class="view-btn active" onclick="switchView('shift')">ç­æ¬¡å°å‘ (æ™‚é–“åœ¨å·¦)</button>
                    <button id="view-person" class="view-btn" onclick="switchView('person')">äººå“¡å°å‘ (å§“ååœ¨å·¦)</button>
                </div>

                <div id="monthDisplay" class="month-label"></div>
                <div id="scheduleTableContainer" style="overflow-x: auto;">
                    <!-- è¡¨æ ¼å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>

                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="saveSchedules()">å„²å­˜æ’ç­</button>
                    <button class="btn btn-outline" onclick="exportCSV()">åŒ¯å‡º CSV</button>
                    <button class="btn btn-danger" onclick="clearWeekSchedule()">æ¸…ç©ºæœ¬é€±</button>
                </div>
            </div>

            <div class="card">
                <h2>æ¯æ—¥ç¸½å·¥æ™‚çµ±è¨ˆ</h2>
                <div id="statsContainer" class="stats-grid">
                    <!-- çµ±è¨ˆå°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- å“¡å·¥ç®¡ç†åˆ†é  -->
        <div id="employees" class="tab-content">
            <div class="card">
                <h2>æ–°å¢å“¡å·¥</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>å§“å</label>
                        <input type="text" id="empName" placeholder="è¼¸å…¥å§“å">
                    </div>
                    <div class="form-group">
                        <label>é¡å‹</label>
                        <select id="empType">
                            <option value="fulltime">æ­£è·</option>
                            <option value="parttime">å…¼è·</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ¯é€±å·¥æ™‚ä¸Šé™</label>
                        <input type="number" id="empMaxHours" value="40">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addEmployee()">æ–°å¢å“¡å·¥</button>
            </div>

            <div class="card">
                <h2>å“¡å·¥åˆ—è¡¨</h2>
                <div id="employeeList">
                    <!-- å“¡å·¥åˆ—è¡¨å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- ç­æ¬¡è¨­å®šåˆ†é  -->
        <div id="shifts" class="tab-content">
            <div class="card">
                <h2>æ–°å¢ç­æ¬¡</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>ç­æ¬¡åç¨±</label>
                        <input type="text" id="shiftName" placeholder="ä¾‹å¦‚ï¼šæ—©ç­">
                    </div>
                    <div class="form-group">
                        <label>é–‹å§‹æ™‚é–“</label>
                        <input type="time" id="shiftStart">
                    </div>
                    <div class="form-group">
                        <label>çµæŸæ™‚é–“</label>
                        <input type="time" id="shiftEnd">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>å¹³æ—¥éœ€æ±‚äººæ•¸</label>
                        <input type="number" id="shiftNeedNormal" value="2">
                    </div>
                    <div class="form-group">
                        <label>æ—ºæ—¥éœ€æ±‚äººæ•¸</label>
                        <input type="number" id="shiftNeedPeak" value="4">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addShift()">æ–°å¢ç­æ¬¡</button>
            </div>

            <div class="card">
                <h2>ç­æ¬¡åˆ—è¡¨ (å¯æ‹–æ›³æ’åº)</h2>
                <div id="shiftList" ondragover="allowDrop(event)">
                    <!-- ç­æ¬¡åˆ—è¡¨å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- å‡æ—¥æ—¥æ›†åˆ†é  -->
        <div id="calendar" class="tab-content">
            <div class="card">
                <div class="calendar-header">
                    <h2>2025-2026 å‡æ—¥æ—¥æ›†</h2>
                    <div class="calendar-nav">
                        <button onclick="changeMonth(-1)">&lt;</button>
                        <span id="calendarMonthDisplay" style="font-weight: 600;"></span>
                        <button onclick="changeMonth(1)">&gt;</button>
                    </div>
                </div>
                <div id="calendarGrid" class="calendar-grid">
                    <!-- æ—¥æ›†å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- æ—ºæ—¥è¨­å®šåˆ†é  -->
        <div id="peak" class="tab-content">
            <div class="card">
                <h2>æ—ºæ—¥è‡ªå‹•åˆ¤å®šè¨­å®š</h2>
                <div class="peak-settings-grid">
                    <div class="peak-option">
                        <input type="checkbox" id="peakWeekend" checked onchange="savePeakSettings()">
                        <label>é€±æœ« (é€±å…­ã€é€±æ—¥)</label>
                    </div>
                    <div class="peak-option">
                        <input type="checkbox" id="peakHoliday" checked onchange="savePeakSettings()">
                        <label>åœ‹å®šå‡æ—¥</label>
                    </div>
                    <div class="peak-option">
                        <input type="checkbox" id="peakWinter" onchange="savePeakSettings()">
                        <label>å¯’å‡ (1/21 - 2/10)</label>
                    </div>
                    <div class="peak-option">
                        <input type="checkbox" id="peakSummer" onchange="savePeakSettings()">
                        <label>æš‘å‡ (7/1 - 8/31)</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <!-- å¿«é€Ÿæ–°å¢é¸å–®å®¹å™¨ -->
    <div id="quickAddMenu" class="quick-add-menu"></div>

    <script>
        // è³‡æ–™çµæ§‹åˆå§‹åŒ–
        let employees = JSON.parse(localStorage.getItem('employees')) || [
            { id: 1, name: 'ç‹å°æ˜', type: 'fulltime', maxHours: 40, prefShifts: [], offDays: [0] },
            { id: 2, name: 'æè¯', type: 'parttime', maxHours: 20, prefShifts: [], offDays: [] }
        ];

        let shifts = JSON.parse(localStorage.getItem('shifts')) || [
            { id: 1, name: 'é–‹æ—©', start: '10:00', end: '15:00', needNormal: 2, needPeak: 3 },
            { id: 2, name: 'ä¸‹åˆ', start: '15:00', end: '18:00', needNormal: 1, needPeak: 2 },
            { id: 3, name: 'æ™šç­', start: '18:00', end: '22:00', needNormal: 3, needPeak: 5 },
            { id: 4, name: 'æ”¶å°¾', start: '22:00', end: '01:00', needNormal: 2, needPeak: 3 }
        ];

        let schedules = JSON.parse(localStorage.getItem('schedules')) || {};
        let weatherData = {};
        let currentView = 'shift'; // 'shift' æˆ– 'person'

        const holidays2025 = {
            '2025-01-01': 'å…ƒæ—¦', 
            '2025-01-25': 'æ˜¥ç¯€å‡æœŸ', '2025-01-26': 'æ˜¥ç¯€å‡æœŸ', '2025-01-27': 'é™¤å¤•å‰ä¸€æ—¥', '2025-01-28': 'é™¤å¤•', 
            '2025-01-29': 'åˆä¸€', '2025-01-30': 'åˆäºŒ', '2025-01-31': 'åˆä¸‰', '2025-02-01': 'åˆå››', '2025-02-02': 'åˆäº”',
            '2025-02-28': 'å’Œå¹³ç´€å¿µæ—¥', '2025-04-03': 'å…’ç«¥ç¯€', '2025-04-04': 'æ¸…æ˜ç¯€', '2025-05-01': 'å‹å‹•ç¯€',
            '2025-05-31': 'ç«¯åˆç¯€', '2025-10-06': 'ä¸­ç§‹ç¯€', '2025-10-10': 'åœ‹æ…¶æ—¥',
            '2026-01-01': 'å…ƒæ—¦',
            '2026-02-16': 'é™¤å¤•', '2026-02-17': 'åˆä¸€', '2026-02-18': 'åˆäºŒ', '2026-02-19': 'åˆä¸‰', '2026-02-20': 'åˆå››', '2026-02-21': 'åˆäº”',
            '2026-02-28': 'å’Œå¹³ç´€å¿µæ—¥', '2026-04-03': 'å…’ç«¥ç¯€', '2026-04-04': 'æ¸…æ˜ç¯€', '2026-05-01': 'å‹å‹•ç¯€',
            '2026-06-19': 'ç«¯åˆç¯€', '2026-09-25': 'ä¸­ç§‹ç¯€', '2026-10-10': 'åœ‹æ…¶æ—¥'
        };

        let currentWeekStart = getMonday(new Date());
        let calendarDate = new Date();

        // åˆå§‹åŒ–
        window.onload = () => {
            fetchWeather();
            renderAll();
            
            // é»æ“Šå¤–éƒ¨é—œé–‰å¿«é€Ÿæ–°å¢é¸å–®
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.quick-add-btn') && !e.target.closest('.quick-add-menu')) {
                    document.getElementById('quickAddMenu').style.display = 'none';
                }
            });
        };

        // ç²å–å¤©æ°£è³‡æ–™ (å®œè˜­ç¾…æ±åº§æ¨™: 24.67, 121.76)
        async function fetchWeather() {
            try {
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=24.67&longitude=121.76&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTaipei&past_days=7');
                const data = await response.json();
                
                data.daily.time.forEach((time, index) => {
                    weatherData[time] = {
                        code: data.daily.weather_code[index],
                        maxTemp: data.daily.temperature_2m_max[index],
                        minTemp: data.daily.temperature_2m_min[index],
                        pop: data.daily.precipitation_probability_max[index]
                    };
                });
                renderScheduleTable();
                renderCalendar();
            } catch (error) {
                console.error('å¤©æ°£ç²å–å¤±æ•—', error);
            }
        }

        function getWeatherIcon(code) {
            if (code === 0) return 'â˜€ï¸';
            if (code <= 3) return 'â›…';
            if (code <= 48) return 'ğŸŒ«ï¸';
            if (code <= 67) return 'ğŸŒ§ï¸';
            if (code <= 77) return 'â„ï¸';
            if (code <= 82) return 'ğŸŒ¦ï¸';
            if (code <= 99) return 'â›ˆï¸';
            return 'â“';
        }

        // è¦–åœ–åˆ‡æ›
        function switchView(view) {
            currentView = view;
            document.getElementById('view-shift').classList.toggle('active', view === 'shift');
            document.getElementById('view-person').classList.toggle('active', view === 'person');
            renderScheduleTable();
        }

        // æ¸²æŸ“æ’ç­è¡¨
        function renderScheduleTable() {
            const container = document.getElementById('scheduleTableContainer');
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                weekDays.push(d);
            }

            // æ›´æ–°é€±ç¯„åœé¡¯ç¤º
            const endDay = new Date(weekDays[6]);
            document.getElementById('weekRangeDisplay').innerText = `${weekDays[0].toLocaleDateString()} - ${endDay.toLocaleDateString()}`;
            
            // æ›´æ–°æœˆä»½é¡¯ç¤º (ä»¥é€±ä¸€ç‚ºæº–)
            document.getElementById('monthDisplay').innerText = `${weekDays[0].getMonth() + 1}æœˆ`;

            let html = `<table class="schedule-table"><thead><tr><th style="width: 150px;">${currentView === 'shift' ? 'ç­æ¬¡' : 'å“¡å·¥'}</th>`;
            
            weekDays.forEach(day => {
                const dateStr = formatDate(day);
                const isPeak = isPeakDay(day);
                const holidayName = holidays2025[dateStr];
                const weather = weatherData[dateStr];
                
                html += `<th class="${holidayName ? 'holiday-day' : (isPeak ? 'peak-day' : '')}">
                    <div style="font-size: 0.8rem; color: #718096;">${getDayName(day.getDay())}</div>
                    <div style="font-size: 1.1rem;">${day.getMonth()+1}/${day.getDate()}</div>`;
                
                if (weather) {
                    html += `<div class="schedule-weather">
                        <div class="weather-main">${getWeatherIcon(weather.code)} ${Math.round(weather.maxTemp)}Â°</div>
                        <div class="weather-detail">
                            <span>${Math.round(weather.minTemp)}Â°</span>
                            <span class="${weather.pop > 40 ? 'high-pop' : ''}">â˜”${weather.pop}%</span>
                        </div>
                    </div>`;
                }
                
                if (holidayName) html += `<div class="holiday-tag">${holidayName}</div>`;
                else if (isPeak) html += `<div class="peak-tag">æ—ºæ—¥</div>`;
                
                html += `</th>`;
            });
            html += `</tr></thead><tbody>`;

            if (currentView === 'shift') {
                // ç­æ¬¡å°å‘è¦–åœ– (åŸæœ¬çš„)
                shifts.forEach(shift => {
                    html += `<tr><td style="background: #f8f9fc;">
                        <div class="shift-label">${shift.name}</div>
                        <div class="shift-time">${shift.start} - ${shift.end}</div>
                    </td>`;
                    
                    weekDays.forEach(day => {
                        const dateStr = formatDate(day);
                        const key = `${dateStr}_${shift.id}`;
                        const assigned = schedules[key] || [];
                        const isPeak = isPeakDay(day);
                        const need = isPeak ? shift.needPeak : shift.needNormal;
                        
                        html += `<td class="${holidays2025[dateStr] ? 'holiday-day' : (isPeak ? 'peak-day' : '')}">
                            <div id="cell_${key}">`;
                        
                        assigned.forEach(empId => {
                            const emp = employees.find(e => e.id == empId);
                            if (emp) {
                                html += `<div class="employee-tag ${emp.type}">
                                    ${emp.name}
                                    <span class="remove-btn" onclick="removeEmployeeFromShift('${dateStr}', ${shift.id}, ${empId})">Ã—</span>
                                </div>`;
                            }
                        });
                        
                        html += `</div>`;
                        if (assigned.length < need) {
                            html += `<div class="need-more">é‚„éœ€ ${need - assigned.length} äºº</div>`;
                        }
                        html += `<div class="quick-add-btn" onclick="showQuickAddMenu(event, '${dateStr}', ${shift.id})">+</div></td>`;
                    });
                    html += `</tr>`;
                });
            } else {
                // äººå“¡å°å‘è¦–åœ– (æ–°å¢åŠ çš„)
                employees.forEach(emp => {
                    html += `<tr><td style="background: #f8f9fc; vertical-align: middle;">
                        <div class="shift-label">${emp.name}</div>
                        <div style="font-size: 0.8rem; color: #718096;">${emp.type === 'fulltime' ? 'æ­£è·' : 'å…¼è·'}</div>
                    </td>`;
                    
                    weekDays.forEach(day => {
                        const dateStr = formatDate(day);
                        const isPeak = isPeakDay(day);
                        html += `<td class="${holidays2025[dateStr] ? 'holiday-day' : (isPeak ? 'peak-day' : '')}">`;
                        
                        // æ‰¾å‡ºè©²å“¡å·¥ç•¶å¤©æ‰€æœ‰çš„ç­æ¬¡
                        let hasShift = false;
                        shifts.forEach(shift => {
                            const key = `${dateStr}_${shift.id}`;
                            const assigned = schedules[key] || [];
                            if (assigned.includes(emp.id)) {
                                hasShift = true;
                                html += `<div class="person-time-tag">
                                    ${shift.name}<br>${shift.start}-${shift.end}
                                    <span class="remove-btn" style="float:right" onclick="removeEmployeeFromShift('${dateStr}', ${shift.id}, ${emp.id})">Ã—</span>
                                </div>`;
                            }
                        });
                        
                        if (!hasShift) {
                            html += `<div style="color: #cbd5e0; font-size: 0.8rem; margin-top: 20px;">ç„¡æ’ç­</div>`;
                        }
                        
                        html += `</td>`;
                    });
                    html += `</tr>`;
                });
            }

            html += `</tbody></table>`;
            container.innerHTML = html;
            updateStats();
        }

        // å¿«é€Ÿæ–°å¢é¸å–®é‚è¼¯
        function showQuickAddMenu(event, dateStr, shiftId) {
            event.stopPropagation();
            const menu = document.getElementById('quickAddMenu');
            const key = `${dateStr}_${shiftId}`;
            const assigned = schedules[key] || [];
            
            let html = '<div style="font-weight: bold; font-size: 12px; margin-bottom: 8px; color: #718096; padding: 0 4px;">å¿«é€ŸåŠ å…¥å“¡å·¥</div>';
            
            const availableEmps = employees.filter(emp => !assigned.includes(emp.id));
            
            if (availableEmps.length === 0) {
                html += '<div style="font-size: 12px; color: #a0aec0; padding: 8px;">ç„¡å¯ç”¨å“¡å·¥</div>';
            } else {
                availableEmps.forEach(emp => {
                    html += `<div class="quick-add-item" onclick="addEmployeeToShift('${dateStr}', ${shiftId}, ${emp.id})">
                        <span>${emp.name}</span>
                        <span style="font-size: 10px; color: #a0aec0;">${emp.type === 'fulltime' ? 'æ­£è·' : 'å…¼è·'}</span>
                    </div>`;
                });
            }
            
            menu.innerHTML = html;
            menu.style.display = 'block';
            menu.style.left = `${event.pageX}px`;
            menu.style.top = `${event.pageY}px`;
        }

        function addEmployeeToShift(dateStr, shiftId, empId) {
            const key = `${dateStr}_${shiftId}`;
            if (!schedules[key]) schedules[key] = [];
            if (!schedules[key].includes(empId)) {
                schedules[key].push(empId);
                saveSchedules();
                renderScheduleTable();
            }
            document.getElementById('quickAddMenu').style.display = 'none';
        }

        function removeEmployeeFromShift(dateStr, shiftId, empId) {
            const key = `${dateStr}_${shiftId}`;
            if (schedules[key]) {
                schedules[key] = schedules[key].filter(id => id != empId);
                saveSchedules();
                renderScheduleTable();
            }
        }

        // è¼”åŠ©å‡½æ•¸
        function getMonday(d) {
            d = new Date(d);
            d.setHours(0,0,0,0);
            let day = d.getDay(),
                diff = d.getDate() - day + (day == 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function formatDate(date) {
            let d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;
            return [year, month, day].join('-');
        }

        function getDayName(dayIndex) {
            return ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'][dayIndex];
        }

        function isPeakDay(date) {
            const dateStr = formatDate(date);
            const day = date.getDay();
            const month = date.getMonth() + 1;
            const d = date.getDate();

            if (document.getElementById('peakWeekend').checked && (day === 0 || day === 6)) return true;
            if (document.getElementById('peakHoliday').checked && holidays2025[dateStr]) return true;
            if (document.getElementById('peakWinter').checked) {
                if ((month === 1 && d >= 21) || (month === 2 && d <= 10)) return true;
            }
            if (document.getElementById('peakSummer').checked && (month === 7 || month === 8)) return true;
            
            return false;
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const container = document.getElementById('statsContainer');
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                weekDays.push(d);
            }

            let html = '';
            weekDays.forEach(day => {
                const dateStr = formatDate(day);
                const isPeak = isPeakDay(day);
                const isHoliday = !!holidays2025[dateStr];
                
                let dailyTotal = 0;
                shifts.forEach(shift => {
                    const key = `${dateStr}_${shift.id}`;
                    const assigned = schedules[key] || [];
                    const duration = calculateDuration(shift.start, shift.end);
                    dailyTotal += assigned.length * duration;
                });

                html += `<div class="stat-card ${isHoliday ? 'holiday' : (isPeak ? 'peak' : '')}">
                    <div class="stat-label">${getDayName(day.getDay())} (${day.getMonth()+1}/${day.getDate()})</div>
                    <div class="stat-value">${dailyTotal.toFixed(1)}h</div>
                    <div class="stat-label">ç•¶æ—¥ç¸½å·¥æ™‚</div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function calculateDuration(start, end) {
            let [sH, sM] = start.split(':').map(Number);
            let [eH, eM] = end.split(':').map(Number);
            let startMin = sH * 60 + sM;
            let endMin = eH * 60 + eM;
            if (endMin <= startMin) endMin += 24 * 60; // è·¨å¤œ
            return (endMin - startMin) / 60;
        }

        // åŸºç¤åŠŸèƒ½
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            renderAll();
        }

        function renderAll() {
            renderScheduleTable();
            renderEmployeeList();
            renderShiftList();
            renderCalendar();
        }

        function changeWeek(offset) {
            currentWeekStart.setDate(currentWeekStart.getDate() + offset * 7);
            renderScheduleTable();
        }

        function saveSchedules() {
            localStorage.setItem('schedules', JSON.stringify(schedules));
            showToast('æ’ç­å·²å„²å­˜');
        }

        function clearWeekSchedule() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæœ¬é€±æ‰€æœ‰æ’ç­å—ï¼Ÿ')) {
                for (let i = 0; i < 7; i++) {
                    const d = new Date(currentWeekStart);
                    d.setDate(d.getDate() + i);
                    const dateStr = formatDate(d);
                    shifts.forEach(s => delete schedules[`${dateStr}_${s.id}`]);
                }
                saveSchedules();
                renderScheduleTable();
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 2000);
        }

        // å“¡å·¥ç®¡ç†
        function renderEmployeeList() {
            const list = document.getElementById('employeeList');
            list.innerHTML = employees.map(emp => `
                <div class="list-item">
                    <div>
                        <strong>${emp.name}</strong> (${emp.type === 'fulltime' ? 'æ­£è·' : 'å…¼è·'})
                        <div style="font-size: 12px; color: #666;">æ¯é€±ä¸Šé™: ${emp.maxHours}h</div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteEmployee(${emp.id})">åˆªé™¤</button>
                </div>
            `).join('');
        }

        function addEmployee() {
            const name = document.getElementById('empName').value;
            if (!name) return alert('è«‹è¼¸å…¥å§“å');
            employees.push({
                id: Date.now(),
                name,
                type: document.getElementById('empType').value,
                maxHours: document.getElementById('empMaxHours').value,
                prefShifts: [],
                offDays: []
            });
            localStorage.setItem('employees', JSON.stringify(employees));
            renderEmployeeList();
            document.getElementById('empName').value = '';
        }

        function deleteEmployee(id) {
            employees = employees.filter(e => e.id != id);
            localStorage.setItem('employees', JSON.stringify(employees));
            renderEmployeeList();
        }

        // ç­æ¬¡ç®¡ç†
        function renderShiftList() {
            const list = document.getElementById('shiftList');
            list.innerHTML = shifts.map((shift, index) => `
                <div class="list-item" draggable="true" ondragstart="drag(event, ${index})" ondrop="drop(event, ${index})" ondragover="allowDrop(event)">
                    <div style="display: flex; align-items: center;">
                        <span class="drag-handle">â˜°</span>
                        <div>
                            <strong>${shift.name}</strong> (${shift.start} - ${shift.end})
                            <div style="font-size: 12px; color: #666;">éœ€æ±‚: å¹³æ—¥${shift.needNormal}äºº / æ—ºæ—¥${shift.needPeak}äºº</div>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteShift(${shift.id})">åˆªé™¤</button>
                </div>
            `).join('');
        }

        function addShift() {
            const name = document.getElementById('shiftName').value;
            if (!name) return alert('è«‹è¼¸å…¥ç­æ¬¡åç¨±');
            shifts.push({
                id: Date.now(),
                name,
                start: document.getElementById('shiftStart').value || '09:00',
                end: document.getElementById('shiftEnd').value || '17:00',
                needNormal: parseInt(document.getElementById('shiftNeedNormal').value),
                needPeak: parseInt(document.getElementById('shiftNeedPeak').value)
            });
            localStorage.setItem('shifts', JSON.stringify(shifts));
            renderShiftList();
        }

        function deleteShift(id) {
            shifts = shifts.filter(s => s.id != id);
            localStorage.setItem('shifts', JSON.stringify(shifts));
            renderShiftList();
        }

        // æ‹–æ›³æ’åºé‚è¼¯
        let draggedIndex = null;
        function drag(event, index) {
            draggedIndex = index;
            event.target.classList.add('dragging');
        }

        function allowDrop(event) {
            event.preventDefault();
        }

        function drop(event, targetIndex) {
            event.preventDefault();
            if (draggedIndex === null || draggedIndex === targetIndex) return;
            
            const movedItem = shifts.splice(draggedIndex, 1)[0];
            shifts.splice(targetIndex, 0, movedItem);
            
            localStorage.setItem('shifts', JSON.stringify(shifts));
            renderShiftList();
            renderScheduleTable();
            draggedIndex = null;
        }

        // æ—¥æ›†æ¸²æŸ“
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthDisplay = document.getElementById('calendarMonthDisplay');
            
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            monthDisplay.innerText = `${year}å¹´ ${month + 1}æœˆ`;

            let html = `
                <div class="day-header">æ—¥</div><div class="day-header">ä¸€</div>
                <div class="day-header">äºŒ</div><div class="day-header">ä¸‰</div>
                <div class="day-header">å››</div><div class="day-header">äº”</div>
                <div class="day-header">å…­</div>
            `;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // å¡«å……ä¸Šå€‹æœˆç©ºç™½
            for (let i = 0; i < firstDay; i++) {
                html += `<div class="day-cell other-month"></div>`;
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const dateStr = formatDate(date);
                const isPeak = isPeakDay(date);
                const holiday = holidays2025[dateStr];
                const weather = weatherData[dateStr];
                
                html += `
                    <div class="day-cell ${holiday ? 'holiday' : (isPeak ? 'peak' : '')}">
                        <div class="date">
                            ${d}
                            ${holiday ? `<span class="holiday-tag">${holiday}</span>` : ''}
                        </div>
                        ${weather ? `<div style="font-size: 10px;">${getWeatherIcon(weather.code)} ${Math.round(weather.maxTemp)}Â°/${Math.round(weather.minTemp)}Â°</div>` : ''}
                        ${isPeak ? `<div class="peak-tag">æ—º</div>` : ''}
                    </div>
                `;
            }
            grid.innerHTML = html;
        }

        function changeMonth(offset) {
            calendarDate.setMonth(calendarDate.getMonth() + offset);
            renderCalendar();
        }

        function savePeakSettings() {
            showToast('æ—ºæ—¥è¨­å®šå·²æ›´æ–°');
            renderAll();
        }

        // AI æ’ç­æ¼”ç®—æ³•
        function runAIScheduling() {
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                weekDays.push(d);
            }

            weekDays.forEach(day => {
                const dateStr = formatDate(day);
                const isPeak = isPeakDay(day);

                shifts.forEach(shift => {
                    const key = `${dateStr}_${shift.id}`;
                    const need = isPeak ? shift.needPeak : shift.needNormal;
                    schedules[key] = [];

                    // ç°¡å–®æ¬Šé‡æ’åºï¼šæ­£è·å„ªå…ˆï¼Œå·¥æ™‚å¹³è¡¡
                    let candidates = employees.map(emp => {
                        let score = emp.type === 'fulltime' ? 100 : 50;
                        // éš¨æ©Ÿæ“¾å‹•
                        score += Math.random() * 10;
                        return { ...emp, score };
                    }).sort((a, b) => b.score - a.score);

                    for (let i = 0; i < need && i < candidates.length; i++) {
                        schedules[key].push(candidates[i].id);
                    }
                });
            });

            saveSchedules();
            renderScheduleTable();
            showToast('AI æ’ç­å®Œæˆ');
        }

        function exportCSV() {
            let csv = 'ç­æ¬¡,æ—¥æœŸ,å“¡å·¥\n';
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(currentWeekStart);
                d.setDate(d.getDate() + i);
                weekDays.push(d);
            }

            shifts.forEach(shift => {
                weekDays.forEach(day => {
                    const dateStr = formatDate(day);
                    const assigned = (schedules[`${dateStr}_${shift.id}`] || [])
                        .map(id => employees.find(e => e.id == id)?.name)
                        .join(';');
                    csv += `${shift.name},${dateStr},${assigned}\n`;
                });
            });

            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `æ’ç­è¡¨_${formatDate(weekDays[0])}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
