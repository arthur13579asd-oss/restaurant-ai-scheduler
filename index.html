<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å»³ AI æ’ç­ç³»çµ± - å®œè˜­ç¾…æ±åº—</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #ed64a6;
            --bg: #f7fafc;
            --card-bg: #ffffff;
            --text: #2d3748;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg); color: var(--text); line-height: 1.6; }
        
        .navbar { background: linear-gradient(135deg, var(--primary), #764ba2); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .navbar h1 { font-size: 1.5rem; font-weight: 800; letter-spacing: -0.5px; }
        .store-name { background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 600; }

        .tabs { display: flex; background: white; padding: 0 2rem; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .tab { padding: 1rem 1.5rem; cursor: pointer; font-weight: 600; color: #718096; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab:hover { color: var(--primary); }
        .tab.active { color: var(--primary); border-bottom-color: var(--primary); }

        .main-content { padding: 2rem; max-width: 1500px; margin: 0 auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--card-bg); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 2rem; border: 1px solid var(--border); }
        .card h2 { margin-bottom: 1.2rem; font-size: 1.25rem; color: #1a202c; display: flex; align-items: center; gap: 8px; }

        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: all 0.2s; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-success { background: #48bb78; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-ai { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 14px 28px; 
            font-size: 1.1rem; 
            border-radius: 30px; 
            box-shadow: 0 4px 15px rgba(102,126,234,0.4); 
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid rgba(255,255,255,0.1);
            animation: pulse-glow 3s infinite;
        }

        .btn-ai:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(102,126,234,0.6);
        }

        .btn-ai:active {
            transform: translateY(1px) scale(0.98);
            box-shadow: 0 2px 10px rgba(102,126,234,0.4);
        }

        /* å¾®å…‰æµå‹•æ•ˆæœ */
        .btn-ai::after {
            content: "";
            position: absolute;
            top: -50%;
            left: -60%;
            width: 20%;
            height: 200%;
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(30deg);
            transition: none;
            animation: shimmer 4s infinite;
        }

        @keyframes shimmer {
            0% { left: -60%; }
            20% { left: 120%; }
            100% { left: 120%; }
        }

        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(102, 126, 234, 0); }
            100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0); }
        }

        /* æ’ç­è¡¨æ¨£å¼ */
        .month-label { font-size: 1.8rem; font-weight: 800; color: #2b6cb0; margin-bottom: 15px; padding-left: 5px; }
        .schedule-table { width: 100%; border-collapse: separate; border-spacing: 0; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); table-layout: fixed; }
        .schedule-table th, .schedule-table td { border: 1px solid var(--border); padding: 12px; text-align: center; vertical-align: top; }
        .schedule-table th { background: #f8fafc; font-weight: 700; color: #4a5568; }
        
        /* äººå“¡å°å‘è¦–åœ–ç¸®å° 30% ä¸¦ä¿æŒç·Šæ¹Š */
        .person-view-table th, .person-view-table td { padding: 4px 2px; font-size: 0.75rem; text-align: center; vertical-align: middle; }
        .person-view-table td:first-child { font-size: 0.9rem; font-weight: 800; text-align: center; }
        .person-view-table .employee-tag { padding: 2px 4px; font-size: 0.65rem; margin: 1px; gap: 2px; }
        .person-view-table .quick-add-btn { width: 18px; height: 18px; font-size: 0.8rem; margin: 2px auto 0; }
        .person-view-table .cell-content { min-height: 30px; gap: 2px; }
        .person-view-table .employee-tag div[style*="font-size:9px"] { font-size: 7px !important; margin-top: 0 !important; }

        .schedule-weather { margin-top: 6px; padding: 6px; background: rgba(255,255,255,0.8); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .weather-main { font-size: 1.1rem; font-weight: 700; display: flex; justify-content: center; align-items: center; gap: 4px; }
        .weather-detail { font-size: 0.75rem; color: #718096; display: flex; justify-content: center; gap: 8px; margin-top: 2px; }
        .high-pop { color: #e53e3e; font-weight: 800; }

        .peak-day { background-color: #fffaf3 !important; }
        .holiday-day { background-color: #fff5f5 !important; }

        .cell-content { min-height: 80px; display: flex; flex-direction: column; gap: 6px; align-items: center; justify-content: center; }
        .employee-tag { background: #edf2f7; padding: 4px 10px; border-radius: 6px; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); width: fit-content; }
        .employee-tag.fulltime { border-left: 4px solid #48bb78; }
        .employee-tag.parttime { border-left: 4px solid #ed8936; }
        .remove-btn { color: #a0aec0; cursor: pointer; font-size: 1.1rem; }
        .remove-btn:hover { color: #f56565; }

        .quick-add-btn { width: 32px; height: 32px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; margin: 8px auto 0; font-size: 1.2rem; transition: all 0.2s; box-shadow: 0 2px 4px rgba(102,126,234,0.3); }
        .quick-add-btn:hover { transform: scale(1.1); background: #5a67d8; }

        .quick-add-menu { position: absolute; background: white; border: 1px solid #e2e8f0; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); display: none; z-index: 1000; min-width: 160px; padding: 8px 0; }
        .quick-add-item { padding: 10px 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; font-weight: 600; }
        .quick-add-item:hover { background: #f7fafc; color: var(--primary); }

        /* çµ±è¨ˆåœ–è¡¨ */
        .stats-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; }
        .stat-card { background: #f8fafc; padding: 12px; border-radius: 10px; text-align: center; border: 1px solid var(--border); }
        .stat-card.peak { border-color: #fbd38d; background: #fffaf3; }
        .stat-card.holiday { border-color: #feb2b2; background: #fff5f5; }
        .stat-value { font-size: 1.25rem; font-weight: 800; color: var(--primary); margin: 4px 0; }
        .stat-label { font-size: 0.75rem; color: #718096; font-weight: 600; }

        /* æ—¥æ›†æ¨£å¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e2e8f0; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .day-header { background: #f8fafc; padding: 12px; text-align: center; font-weight: 700; color: #4a5568; }
        .day-cell { background: white; min-height: 100px; padding: 8px; position: relative; }
        .day-cell.other-month { background: #f7fafc; color: #cbd5e0; }
        .day-cell.peak { background: #fffaf3; }
        .day-cell.holiday { background: #fff5f5; }
        .day-cell .date { font-weight: 700; display: flex; justify-content: space-between; align-items: flex-start; }
        .holiday-name { font-size: 10px; color: #e53e3e; background: #fff5f5; padding: 2px 4px; border-radius: 4px; border: 1px solid #feb2b2; }
        .peak-tag { position: absolute; bottom: 8px; right: 8px; background: #ed8936; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 800; }

        /* å“¡å·¥åˆ—è¡¨å„ªåŒ– */
        .employee-table-container { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); }
        .employee-table { width: 100%; border-collapse: collapse; background: white; }
        .employee-table th { background: #f8fafc; padding: 12px 16px; text-align: left; font-size: 13px; font-weight: 700; color: #4a5568; border-bottom: 2px solid var(--border); }
        .employee-table td { padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
        .employee-table tr:hover { background-color: #f7fafc; }
        .type-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; }
        .type-fulltime { background: #d4edda; color: #155724; }
        .type-parttime { background: #fff3cd; color: #856404; }
        .avail-dot { display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; border-radius: 50%; margin-right: 2px; font-size: 11px; background: #edf2f7; color: #a0aec0; }
        .avail-dot.active { background: #667eea; color: white; }

        /* ç­æ¬¡åˆ—è¡¨ */
        .shift-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; }
        .drag-handle { cursor: move; color: #cbd5e0; font-size: 1.2rem; }
        .shift-item input[type="time"] { padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-weight: 600; }

        /* è¦–åœ–åˆ‡æ›æŒ‰éˆ• */
        .view-switcher { display: flex; gap: 2px; background: #edf2f7; padding: 4px; border-radius: 10px; width: fit-content; margin-bottom: 15px; }
        .view-btn { padding: 6px 16px; border-radius: 8px; border: none; cursor: pointer; font-size: 0.85rem; font-weight: 700; color: #718096; background: transparent; transition: all 0.2s; }
        .view-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="navbar">
        <h1>é¤å»³ AI æ’ç­ç³»çµ±</h1>
        <div class="store-name">å®œè˜­ç¾…æ±åº—</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('schedule')">æ’ç­è¡¨</div>
        <div class="tab" onclick="switchTab('employees')">å“¡å·¥ç®¡ç†</div>
        <div class="tab" onclick="switchTab('shifts')">ç­æ¬¡è¨­å®š</div>
        <div class="tab" onclick="switchTab('holidays')">å‡æ—¥æ—¥æ›†</div>
        <div class="tab" onclick="switchTab('peak-settings')">æ—ºæ—¥è¨­å®š</div>
    </div>

    <div class="main-content">
        <div id="schedule" class="tab-content active">
               <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn-ai" onclick="runAIScheduling()" style="width: 100%; max-width: 400px; justify-content: center;">âœ¨ ä¸€éµ AI æ™ºèƒ½æ’ç­</button>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2>æœ¬é€±æ’ç­è¡¨</h2>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button class="btn" style="background:#edf2f7" onclick="changeWeek(-1)">&lt; ä¸Šé€±</button>
                        <span id="current-week-label" style="font-weight: 700; font-size: 1rem;"></span>
                        <button class="btn" style="background:#edf2f7" onclick="changeWeek(1)">ä¸‹é€± &gt;</button>
                    </div>
                </div>

                <div class="view-switcher">
                    <button id="view-shift" class="view-btn active" onclick="switchView('shift')">ç­æ¬¡å°å‘ (24H)</button>
                    <button id="view-person" class="view-btn" onclick="switchView('person')">äººå“¡å°å‘ (24H)</button>
                </div>
                
                <div id="schedule-container"></div>

                <div style="margin-top: 20px; display: flex; gap: 12px;">
                    <button class="btn btn-success" onclick="saveSchedule()">å„²å­˜æ’ç­</button>
                    <button class="btn" style="background:#edf2f7" onclick="exportCSV()">åŒ¯å‡º CSV</button>
                    <button class="btn" style="background:#e2e8f0; color:#2d3748;" onclick="exportPDF()">åŒ¯å‡º PDF</button>
                    <button class="btn btn-danger" onclick="clearWeekSchedule()">æ¸…ç©ºæœ¬é€±</button>
                </div>
            </div>

            <div class="card">
                <h2>æ¯æ—¥ç¸½å·¥æ™‚çµ±è¨ˆ</h2>
                <div id="daily-stats" class="stats-grid"></div>
            </div>
        </div>

        <div id="employees" class="tab-content">
            <div class="card">
                <h2>æ–°å¢å“¡å·¥</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 12px;">
                    <div style="display: flex; flex-direction: column;">
                        <label style="font-size: 12px; margin-bottom: 4px;">å§“å</label>
                        <input type="text" id="emp-name" placeholder="è¼¸å…¥å§“å" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div style="display: flex; flex-direction: column;">
                        <label style="font-size: 12px; margin-bottom: 4px;">é¡å‹</label>
                        <select id="emp-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="fulltime">æ­£è·</option>
                            <option value="parttime">å…¼è·</option>
                        </select>
                    </div>
                    <div style="display: flex; flex-direction: column;">
                        <label style="font-size: 12px; margin-bottom: 4px;">æ¯é€±æœ€å¤šå·¥ä½œå¤©æ•¸</label>
                        <input type="number" id="emp-max-days" value="5" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div style="display: flex; flex-direction: column;">
                        <label style="font-size: 12px; margin-bottom: 4px;">æ¯é€±æœ€å¤šå·¥ä½œå°æ™‚</label>
                        <input type="number" id="emp-max-hours" value="40" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                </div>
                <div style="margin-bottom: 12px;">
                    <label style="font-size: 12px; font-weight: 500; color: #555;">å¯ç”¨æ™‚æ®µ</label>
                    <div style="display: flex; gap: 8px; margin-top: 4px; font-size: 13px;">
                        <label><input type="checkbox" class="emp-avail" value="1" checked> é€±ä¸€</label>
                        <label><input type="checkbox" class="emp-avail" value="2" checked> é€±äºŒ</label>
                        <label><input type="checkbox" class="emp-avail" value="3" checked> é€±ä¸‰</label>
                        <label><input type="checkbox" class="emp-avail" value="4" checked> é€±å››</label>
                        <label><input type="checkbox" class="emp-avail" value="5" checked> é€±äº”</label>
                        <label><input type="checkbox" class="emp-avail" value="6" checked> é€±å…­</label>
                        <label><input type="checkbox" class="emp-avail" value="0" checked> é€±æ—¥</label>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addEmployee()">æ–°å¢å“¡å·¥</button>
            </div>
            <div class="card">
                <h2>å“¡å·¥åˆ—è¡¨ <span id="emp-count" style="background:#667eea; color:white; font-size:11px; padding:2px 8px; border-radius:10px; margin-left:8px;">0</span></h2>
                <div id="employee-list"></div>
            </div>
        </div>

        <div id="shifts" class="tab-content">
            <div class="card">
                <h2>ç­æ¬¡è¨­å®š (24H æ ¼å¼ / å¯æ‹–æ›³æ’åº)</h2>
                <div id="shift-list" class="shift-list"></div>
                <button class="btn btn-primary" style="margin-top: 15px;" onclick="addShift()">æ–°å¢ç­æ¬¡</button>
            </div>
        </div>

        <div id="holidays" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2>å‡æ—¥æ—¥æ›†</h2>
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <button class="btn" onclick="changeCalendarMonth(-1)">&lt;</button>
                        <div id="calendar-month-label" style="font-weight: 700; font-size: 1.1rem; min-width: 120px; text-align: center;"></div>
                        <button class="btn" onclick="changeCalendarMonth(1)">&gt;</button>
                    </div>
                </div>
                <div id="calendar-grid" class="calendar-grid">
                    <div class="day-header">æ—¥</div><div class="day-header">ä¸€</div><div class="day-header">äºŒ</div><div class="day-header">ä¸‰</div><div class="day-header">å››</div><div class="day-header">äº”</div><div class="day-header">å…­</div>
                </div>
            </div>
        </div>

        <div id="peak-settings" class="tab-content">
            <div class="card">
                <h2>æ—ºæ—¥åˆ¤å®šè¨­å®š</h2>
                <div style="display: flex; flex-direction: column; gap: 12px; font-size: 14px;">
                    <label><input type="checkbox" id="peak-weekend" checked> é€±å…­ã€é€±æ—¥è¦–ç‚ºæ—ºæ—¥</label>
                    <label><input type="checkbox" id="peak-holiday" checked> åœ‹å®šå‡æ—¥è¦–ç‚ºæ—ºæ—¥</label>
                    <label><input type="checkbox" id="peak-vacation" checked> å¤§å­¸å¯’æš‘å‡æœŸé–“è¦–ç‚ºæ—ºæ—¥</label>
                </div>
            </div>
        </div>
    </div>

    <div id="quick-add-menu" class="quick-add-menu"></div>

    <script>
        let employees = JSON.parse(localStorage.getItem('employees')) || [
            { id: 1, name: 'ç‹å°æ˜', type: 'fulltime', maxDays: 5, maxHours: 40, availability: [1,2,3,4,5,6,0] },
            { id: 2, name: 'æè¯', type: 'parttime', maxDays: 4, maxHours: 32, availability: [1,2,3,6,0] }
        ];
        let shifts = JSON.parse(localStorage.getItem('shifts')) || [
            { id: 1, name: 'é–‹æ—©', startTime: '10:00', endTime: '15:00', normalNeed: 2, peakNeed: 3 },
            { id: 2, name: 'ä¸‹åˆ', startTime: '15:00', endTime: '18:00', normalNeed: 1, peakNeed: 2 },
            { id: 3, name: 'æ™šç­', startTime: '18:00', endTime: '22:00', normalNeed: 3, peakNeed: 5 },
            { id: 4, name: 'æ”¶å°¾', startTime: '22:00', endTime: '01:00', normalNeed: 2, peakNeed: 3 }
        ];
        let schedules = JSON.parse(localStorage.getItem('schedules')) || {};
        let weatherData = {};
        let currentView = 'shift';
        let currentWeekStart = getMonday(new Date());
        let calendarDate = new Date();

        const holidays = {
            '2025-01-01': 'å…ƒæ—¦', '2025-01-28': 'é™¤å¤•', '2025-01-29': 'åˆä¸€', '2025-01-30': 'åˆäºŒ', '2025-01-31': 'åˆä¸‰', '2025-02-01': 'åˆå››', '2025-02-02': 'åˆäº”',
            '2025-02-28': 'å’Œå¹³ç´€å¿µæ—¥', '2025-04-04': 'æ¸…æ˜ç¯€', '2025-05-01': 'å‹å‹•ç¯€', '2025-05-31': 'ç«¯åˆç¯€', '2025-10-06': 'ä¸­ç§‹ç¯€', '2025-10-10': 'åœ‹æ…¶æ—¥',
            '2026-01-01': 'å…ƒæ—¦', '2026-02-16': 'é™¤å¤•', '2026-02-17': 'åˆä¸€', '2026-02-18': 'åˆäºŒ', '2026-02-19': 'åˆä¸‰', '2026-02-20': 'åˆå››', '2026-02-21': 'åˆäº”',
            '2026-02-28': 'å’Œå¹³ç´€å¿µæ—¥', '2026-04-04': 'æ¸…æ˜ç¯€', '2026-05-01': 'å‹å‹•ç¯€', '2026-06-19': 'ç«¯åˆç¯€', '2026-09-25': 'ä¸­ç§‹ç¯€', '2026-10-10': 'åœ‹æ…¶æ—¥'
        };

        function init() {
            renderEmployeeList(); renderShiftList(); renderScheduleTable(); fetchWeather();
            
            // æ¯å°æ™‚è‡ªå‹•æ›´æ–°ä¸€æ¬¡å¤©æ°£
            setInterval(fetchWeather, 3600000);

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.quick-add-btn') && !e.target.closest('.quick-add-menu')) {
                    document.getElementById('quick-add-menu').style.display = 'none';
                }
            });
        }

        function getMonday(d) {
            d = new Date(d); let day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        async function fetchWeather() {
            try {
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=24.67&longitude=121.76&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTaipei&past_days=7');
                const data = await response.json();
                data.daily.time.forEach((dateStr, index) => {
                    weatherData[dateStr] = { code: data.daily.weathercode[index], maxTemp: data.daily.temperature_2m_max[index], minTemp: data.daily.temperature_2m_min[index], pop: data.daily.precipitation_probability_max[index] };
                });
                renderScheduleTable();
            } catch (e) { console.error(e); }
        }

        function getWeatherEmoji(code) {
            if (code <= 1) return 'â˜€ï¸'; if (code <= 3) return 'â›…'; if (code <= 48) return 'ğŸŒ«ï¸';
            if (code <= 67) return 'ğŸŒ§ï¸'; if (code <= 77) return 'â„ï¸'; if (code <= 82) return 'ğŸŒ¦ï¸';
            return 'â›ˆï¸';
        }

        function isPeakDay(date) {
            const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const day = date.getDay();
            if (document.getElementById('peak-weekend').checked && (day === 0 || day === 6)) return true;
            if (document.getElementById('peak-holiday').checked && holidays[dateStr]) return true;
            if (document.getElementById('peak-vacation').checked) {
                const month = date.getMonth() + 1; if (month === 1 || month === 2 || month === 7 || month === 8) return true;
            }
            return false;
        }

        function switchView(view) {
            currentView = view;
            document.getElementById('view-shift').classList.toggle('active', view === 'shift');
            document.getElementById('view-person').classList.toggle('active', view === 'person');
            renderScheduleTable();
        }

        function renderScheduleTable() {
            const container = document.getElementById('schedule-container');
            const weekLabel = document.getElementById('current-week-label');
            const start = new Date(currentWeekStart);
            const end = new Date(start); end.setDate(end.getDate() + 6);
            weekLabel.innerText = `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
            const monthName = (start.getMonth() + 1) + "æœˆ";
            
            let tableClass = currentView === 'person' ? 'schedule-table person-view-table' : 'schedule-table';
            let html = `<div class="month-label">${monthName}</div><table class="${tableClass}"><thead><tr><th>${currentView === 'shift' ? 'ç­æ¬¡' : 'å“¡å·¥'}</th>`;
            
            const days = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'];
            for (let i = 0; i < 7; i++) {
                const d = new Date(start); d.setDate(d.getDate() + i);
                const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                const isPeak = isPeakDay(d); const holiday = holidays[dateStr]; const weather = weatherData[dateStr];
                html += `<th class="${isPeak ? 'peak-day' : ''} ${holiday ? 'holiday-day' : ''}"><div>${days[i]}</div><div style="font-size:0.75rem; color:#718096">${(d.getMonth()+1)}/${d.getDate()}</div>`;
                if (weather) html += `<div class="schedule-weather"><div class="weather-main">${getWeatherEmoji(weather.code)} ${Math.round(weather.maxTemp)}Â°</div><div class="weather-detail"><span>${Math.round(weather.minTemp)}Â°</span><span class="${weather.pop > 40 ? 'high-pop' : ''}">â˜”${weather.pop}%</span></div></div>`;
                if (holiday) html += `<div style="color:#e53e3e; font-size:9px">${holiday}</div>`;
                if (isPeak) html += `<div style="color:#ed8936; font-size:9px">æ—ºæ—¥</div>`;
                html += `</th>`;
            }
            html += `</tr></thead><tbody>`;

            if (currentView === 'shift') {
                shifts.forEach(shift => {
                    html += `<tr><td><div style="font-weight:700">${shift.name}</div><div style="font-size:14px; font-weight:600; color:#4a5568; margin-top:2px;">${shift.startTime} - ${shift.endTime}</div></td>`;
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(start); d.setDate(d.getDate() + i);
                        const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                        const key = `${dateStr}_${shift.id}`; const assigned = schedules[key] || [];
                        html += `<td class="${isPeakDay(d) ? 'peak-day' : ''}"><div class="cell-content">`;
                        assigned.forEach(empId => {
                            const emp = employees.find(e => e.id == empId);
                            if (emp) html += `<span class="employee-tag ${emp.type}">${emp.name}<span class="remove-btn" onclick="removeFromShift('${key}', ${emp.id})">Ã—</span></span>`;
                        });
                        html += `</div><div class="quick-add-btn" onclick="showQuickAdd(event, '${key}', 'shift')">+</div></td>`;
                    }
                    html += `</tr>`;
                });
            } else {
                employees.forEach(emp => {
                    html += `<tr><td><div style="font-weight:700">${emp.name}</div><div style="font-size:11px; color:#718096">${emp.type === 'fulltime' ? 'æ­£è·' : 'å…¼è·'}</div></td>`;
                    for (let i = 0; i < 7; i++) {
                        const d = new Date(start); d.setDate(d.getDate() + i);
                        const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                        html += `<td class="${isPeakDay(d) ? 'peak-day' : ''}"><div class="cell-content">`;
                        shifts.forEach(shift => {
                            const key = `${dateStr}_${shift.id}`;
                            if ((schedules[key] || []).includes(emp.id)) {
                                html += `<span class="employee-tag" style="background:#ebf4ff; border-left:4px solid #3182ce; flex-direction:column; align-items:flex-start; padding:4px 8px;">
                                    <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                                        <span style="color:#2b6cb0">${shift.name}</span>
                                        <span class="remove-btn" onclick="removeFromShift('${key}', ${emp.id})">Ã—</span>
                                    </div>
                                    <div style="font-size:11px; font-weight:600; color:#4a5568; margin-top:1px;">${shifts.find(s => s.id === shift.id)?.startTime || shift.startTime}-${shifts.find(s => s.id === shift.id)?.endTime || shift.endTime}</div>
                                </span>`;
                            }
                        });
                        html += `</div><div class="quick-add-btn" onclick="showQuickAdd(event, '${dateStr}', 'person', ${emp.id})">+</div></td>`;
                    }
                    html += `</tr>`;
                });
            }
            html += `</tbody></table>`;
            container.innerHTML = html; updateStats();
        }

        function showQuickAdd(event, key, type, empId = null) {
            event.stopPropagation();
            const menu = document.getElementById('quick-add-menu');
            let html = `<div style="font-weight:bold; margin-bottom:6px; padding:0 10px; color:#4a5568; font-size:12px">å¿«é€Ÿæ–°å¢${type === 'shift' ? 'äººå“¡' : 'ç­æ¬¡'}</div>`;
            if (type === 'shift') {
                const assigned = schedules[key] || [];
                employees.forEach(emp => {
                    if (!assigned.includes(emp.id)) html += `<div class="quick-add-item" onclick="addToShift('${key}', ${emp.id})"><span>${emp.name}</span><span style="font-size:9px; color:#aaa">${emp.type === 'fulltime' ? 'æ­£è·' : 'å…¼è·'}</span></div>`;
                });
            } else {
                shifts.forEach(shift => {
                    const shiftKey = `${key}_${shift.id}`;
                    if (!(schedules[shiftKey] || []).includes(empId)) {
                        const currentShift = shifts.find(s => s.id === shift.id) || shift;
                        html += `<div class="quick-add-item" onclick="addToShift('${shiftKey}', ${empId})"><span>${currentShift.name}</span><span style="font-size:11px; font-weight:600; color:#718096">${currentShift.startTime}-${currentShift.endTime}</span></div>`;
                    }
                });
            }
            menu.innerHTML = html; menu.style.display = 'block';
            menu.style.left = event.pageX + 'px'; menu.style.top = event.pageY + 'px';
        }

        function addToShift(key, empId) {
            if (!schedules[key]) schedules[key] = [];
            if (!schedules[key].includes(empId)) { schedules[key].push(empId); renderScheduleTable(); }
            document.getElementById('quick-add-menu').style.display = 'none';
        }

        function removeFromShift(key, empId) {
            if (schedules[key]) { schedules[key] = schedules[key].filter(id => id != empId); renderScheduleTable(); }
        }

        function updateStats() {
            const statsContainer = document.getElementById('daily-stats');
            const start = new Date(currentWeekStart); const days = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­', 'é€±æ—¥'];
            let html = '';
            for (let i = 0; i < 7; i++) {
                const d = new Date(start); d.setDate(d.getDate() + i);
                const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                let dailyHours = 0;
                shifts.forEach(shift => {
                    const assigned = schedules[`${dateStr}_${shift.id}`] || [];
                    let sH = parseInt(shift.startTime.split(':')[0]), eH = parseInt(shift.endTime.split(':')[0]);
                    let sM = parseInt(shift.startTime.split(':')[1]), eM = parseInt(shift.endTime.split(':')[1]);
                    let startTotal = sH * 60 + sM, endTotal = eH * 60 + eM;
                    if (endTotal < startTotal) endTotal += 24 * 60;
                    dailyHours += assigned.length * ((endTotal - startTotal) / 60);
                });
                html += `<div class="stat-card ${isPeakDay(d) ? 'peak' : ''} ${holidays[dateStr] ? 'holiday' : ''}"><div class="stat-label">${days[i]} (${(d.getMonth()+1)}/${d.getDate()})</div><div class="stat-value">${dailyHours.toFixed(1)}h</div><div class="stat-label">ç•¶æ—¥ç¸½å·¥æ™‚</div></div>`;
            }
            statsContainer.innerHTML = html;
        }

        function renderEmployeeList() {
            const list = document.getElementById('employee-list');
            document.getElementById('emp-count').innerText = employees.length;
            let html = `<div class="employee-table-container"><table class="employee-table"><thead><tr><th>å§“å</th><th>é¡å‹</th><th>æ¯é€±ä¸Šé™</th><th>å¯ç”¨æ™‚æ®µ</th><th style="text-align:right">æ“ä½œ</th></tr></thead><tbody>`;
            employees.forEach((emp, index) => {
                let availHtml = ''; [1, 2, 3, 4, 5, 6, 0].forEach(d => { availHtml += `<span class="avail-dot ${emp.availability.includes(d) ? 'active' : ''}">${['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d]}</span>`; });
                html += `<tr><td style="font-weight:700">${emp.name}</td><td><span class="type-badge ${emp.type === 'fulltime' ? 'type-fulltime' : 'type-parttime'}">${emp.type === 'fulltime' ? 'æ­£è·' : 'å…¼è·'}</span></td><td>${emp.maxDays}å¤© / ${emp.maxHours}h</td><td>${availHtml}</td><td style="text-align:right"><button class="btn" style="padding:4px 8px; background:#fff5f5; color:#e53e3e; border:1px solid #feb2b2; font-size:12px" onclick="deleteEmployee(${index})">åˆªé™¤</button></td></tr>`;
            });
            list.innerHTML = html + `</tbody></table></div>`;
        }

        function addEmployee() {
            const name = document.getElementById('emp-name').value; if (!name) return alert('è«‹è¼¸å…¥å§“å');
            const type = document.getElementById('emp-type').value; const maxDays = parseInt(document.getElementById('emp-max-days').value);
            const maxHours = parseInt(document.getElementById('emp-max-hours').value); const availability = Array.from(document.querySelectorAll('.emp-avail:checked')).map(cb => parseInt(cb.value));
            employees.push({ id: Date.now(), name, type, maxDays, maxHours, availability });
            localStorage.setItem('employees', JSON.stringify(employees)); renderEmployeeList(); document.getElementById('emp-name').value = '';
        }

        function deleteEmployee(index) { if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { employees.splice(index, 1); localStorage.setItem('employees', JSON.stringify(employees)); renderEmployeeList(); } }

        function createTimeSelect(index, field, currentValue) {
            const [h, m] = currentValue.split(':');
            let html = `<div style="display:flex; gap:2px; align-items:center;">`;
            
            // å°æ™‚é¸å–®
            html += `<select onchange="updateShift(${index}, '${field}', this.value + ':' + '${m}')" style="padding:2px 4px; border:none; background:transparent; font-weight:700; color:#2b6cb0; cursor:pointer; font-size:13px;">`;
            for(let i=0; i<24; i++) {
                const val = i.toString().padStart(2, '0');
                html += `<option value="${val}" ${val === h ? 'selected' : ''}>${val}</option>`;
            }
            html += `</select><span style="color:#2b6cb0; font-weight:700;">:</span>`;
            
            // åˆ†é˜é¸å–®
            html += `<select onchange="updateShift(${index}, '${field}', '${h}' + ':' + this.value)" style="padding:2px 4px; border:none; background:transparent; font-weight:700; color:#2b6cb0; cursor:pointer; font-size:13px;">`;
            ['00', '15', '30', '45'].forEach(val => {
                html += `<option value="${val}" ${val === m ? 'selected' : ''}>${val}</option>`;
            });
            html += `</select></div>`;
            return html;
        }

        function renderShiftList() {
            const list = document.getElementById('shift-list'); list.innerHTML = '';
            shifts.forEach((shift, index) => {
                const item = document.createElement('div'); item.className = 'shift-item'; item.draggable = true;
                
                const startTimeSelect = createTimeSelect(index, 'startTime', shift.startTime);
                const endTimeSelect = createTimeSelect(index, 'endTime', shift.endTime);

                item.innerHTML = `
                    <div class="drag-handle">â˜°</div>
                    <input type="text" value="${shift.name}" onchange="updateShift(${index}, 'name', this.value)" style="padding:6px; border:1px solid #ddd; border-radius:4px; width:100px; font-weight:700; color:#2d3748;">
                    <div style="display:flex; align-items:center; gap:4px; background:#ebf4ff; padding:4px 10px; border-radius:6px; border-left:4px solid #3182ce;">
                        <div style="display:flex; flex-direction:column;">
                            <div style="display:flex; align-items:center; gap:4px;">
                                <span style="font-size:13px; font-weight:700; color:#2b6cb0;">${startTimeSelect}</span>
                                <span style="color:#2b6cb0; font-weight:700;">-</span>
                                <span style="font-size:13px; font-weight:700; color:#2b6cb0;">${endTimeSelect}</span>
                            </div>
                        </div>
                    </div>
                    <div style="font-size:13px; color:#4a5568;">å¹³æ—¥: <input type="number" style="width:45px; padding:6px; border:1px solid #ddd; border-radius:4px;" value="${shift.normalNeed}" onchange="updateShift(${index}, 'normalNeed', this.value)"></div>
                    <div style="font-size:13px; color:#4a5568;">æ—ºæ—¥: <input type="number" style="width:45px; padding:6px; border:1px solid #ddd; border-radius:4px;" value="${shift.peakNeed}" onchange="updateShift(${index}, 'peakNeed', this.value)"></div>
                    <button class="btn" style="padding:6px 12px; background:#fff5f5; color:#e53e3e; border:1px solid #feb2b2; font-size:13px;" onclick="deleteShift(${index})">åˆªé™¤</button>
                `;
                item.addEventListener('dragstart', () => item.classList.add('dragging'));
                item.addEventListener('dragend', () => { item.classList.remove('dragging'); saveShifts(); });
                list.appendChild(item);
            });
            list.addEventListener('dragover', e => {
                e.preventDefault(); const draggingItem = document.querySelector('.dragging'); const siblings = [...list.querySelectorAll('.shift-item:not(.dragging)')];
                const nextSibling = siblings.find(sibling => e.clientY <= sibling.offsetTop + sibling.offsetHeight / 2);
                list.insertBefore(draggingItem, nextSibling);
            });
        }

        function updateShift(index, field, value) { 
            if (field === 'startTime' || field === 'endTime') {
                if (!/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(value)) {
                    alert('è«‹è¼¸å…¥æ­£ç¢ºçš„ 24 å°æ™‚åˆ¶æ ¼å¼ (ä¾‹å¦‚ 09:00 æˆ– 18:30)');
                    renderShiftList();
                    return;
                }
            }
            shifts[index][field] = (field.includes('Need') ? parseInt(value) : value); 
            localStorage.setItem('shifts', JSON.stringify(shifts)); 
            renderShiftList(); // ç«‹å³é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°ä¸‹æ‹‰é¸å–®ç‹€æ…‹
            renderScheduleTable(); // ç«‹å³é‡æ–°æ¸²æŸ“æ’ç­è¡¨
        }
        function addShift() { shifts.push({ id: Date.now(), name: 'æ–°ç­æ¬¡', startTime: '09:00', endTime: '17:00', normalNeed: 1, peakNeed: 2 }); localStorage.setItem('shifts', JSON.stringify(shifts)); renderShiftList(); renderScheduleTable(); }
        function deleteShift(index) { if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { shifts.splice(index, 1); localStorage.setItem('shifts', JSON.stringify(shifts)); renderShiftList(); renderScheduleTable(); } }
        function saveShifts() { 
            const newShifts = []; 
            document.querySelectorAll('.shift-item').forEach(item => { 
                const name = item.querySelector('input[type="text"]').value; 
                const shift = shifts.find(s => s.name === name);
                if (shift) newShifts.push(shift);
            }); 
            shifts = newShifts; 
            localStorage.setItem('shifts', JSON.stringify(shifts)); 
            renderShiftList();
            renderScheduleTable(); 
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid'); const monthLabel = document.getElementById('calendar-month-label');
            const year = calendarDate.getFullYear(), month = calendarDate.getMonth();
            monthLabel.innerText = `${year}å¹´ ${month + 1}æœˆ`;
            const headers = Array.from(grid.querySelectorAll('.day-header')); grid.innerHTML = ''; headers.forEach(h => grid.appendChild(h));
            const firstDay = new Date(year, month, 1).getDay(), daysInMonth = new Date(year, month + 1, 0).getDate(), prevMonthDays = new Date(year, month, 0).getDate();
            for (let i = firstDay - 1; i >= 0; i--) { const cell = document.createElement('div'); cell.className = 'day-cell other-month'; cell.innerText = prevMonthDays - i; grid.appendChild(cell); }
            for (let i = 1; i <= daysInMonth; i++) {
                const d = new Date(year, month, i); const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                const cell = document.createElement('div'); cell.className = 'day-cell';
                if (isPeakDay(d)) cell.classList.add('peak'); if (holidays[dateStr]) cell.classList.add('holiday');
                const holidayName = holidays[dateStr] || ''; const isPeak = isPeakDay(d);
                cell.innerHTML = `<div class="date"><span>${i}</span>${holidayName ? `<span class="holiday-name">${holidayName}</span>` : ''}</div>${isPeak ? `<div class="peak-tag">æ—º</div>` : ''}`;
                grid.appendChild(cell);
            }
        }

        function changeCalendarMonth(offset) { calendarDate.setMonth(calendarDate.getMonth() + offset); renderCalendar(); }
        function switchTab(tabId) { document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); event.target.classList.add('active'); document.getElementById(tabId).classList.add('active'); if (tabId === 'holidays') renderCalendar(); }
        function changeWeek(offset) { 
            currentWeekStart.setDate(currentWeekStart.getDate() + (offset * 7)); 
            renderScheduleTable(); 
            fetchWeather(); // åˆ‡æ›é€±æ¬¡æ™‚è‡ªå‹•æ›´æ–°å¤©æ°£é å ±
        }
        function saveSchedule() { localStorage.setItem('schedules', JSON.stringify(schedules)); alert('æ’ç­å·²å„²å­˜ï¼'); }

        function exportPDF() {
            const element = document.getElementById('schedule-container');
            const weekLabel = document.getElementById('current-week-label').innerText;
            const viewName = currentView === 'shift' ? 'ç­æ¬¡å°å‘' : 'äººå“¡å°å‘';
            
            // æš«æ™‚éš±è—å¿«é€Ÿæ–°å¢æŒ‰éˆ•å’Œåˆªé™¤æŒ‰éˆ•ä»¥é€²è¡Œä¹¾æ·¨çš„åŒ¯å‡º
            const style = document.createElement('style');
            style.innerHTML = `
                .quick-add-btn, .remove-btn { display: none !important; }
                .schedule-table { border: 1px solid #000 !important; }
                .schedule-table th, .schedule-table td { border: 1px solid #000 !important; }
            `;
            document.head.appendChild(style);

            const opt = {
                margin: [10, 10, 10, 10],
                filename: `é¤å»³æ’ç­è¡¨_${weekLabel}_${viewName}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                document.head.removeChild(style);
            });
        }
        function clearWeekSchedule() { if (confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) { const start = new Date(currentWeekStart); for (let i = 0; i < 7; i++) { const d = new Date(start); d.setDate(d.getDate() + i); const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; shifts.forEach(s => delete schedules[`${dateStr}_${s.id}`]); } renderScheduleTable(); } }
        function exportCSV() { let csv = 'ç­æ¬¡/å“¡å·¥,é€±ä¸€,é€±äºŒ,é€±ä¸‰,é€±å››,é€±äº”,é€±å…­,é€±æ—¥\n'; shifts.forEach(s => { csv += `${s.name},`; for (let i = 0; i < 7; i++) { const d = new Date(currentWeekStart); d.setDate(d.getDate() + i); const dateStr = d.toISOString().split('T')[0]; csv += `"${(schedules[`${dateStr}_${s.id}`] || []).map(id => employees.find(e => e.id == id)?.name).join(' ')}",`; } csv += '\n'; }); const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "schedule.csv"; link.click(); }
        function runAIScheduling() {
            const start = new Date(currentWeekStart);
            for (let i = 0; i < 7; i++) {
                const d = new Date(start); d.setDate(d.getDate() + i);
                const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                const day = d.getDay(); const isPeak = isPeakDay(d);
                shifts.forEach(shift => {
                    const need = isPeak ? shift.peakNeed : shift.normalNeed; const key = `${dateStr}_${shift.id}`; schedules[key] = [];
                    let candidates = employees.filter(emp => emp.availability.includes(day)).map(emp => ({ emp, score: (emp.type === 'fulltime' ? 100 : 50) + Math.random() * 20 })).sort((a, b) => b.score - a.score);
                    for (let j = 0; j < Math.min(need, candidates.length); j++) { schedules[key].push(candidates[j].emp.id); }
                });
            }
            renderScheduleTable(); alert('AI æ’ç­å®Œæˆï¼');
        }

        init();
    </script>
</body>
</html>
